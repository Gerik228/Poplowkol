(function () {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö API
  if (!('sendBeacon' in navigator) || !('fetch' in window)) {
    console.warn('Logout script skipped: unsupported browser');
    return;
  }

  /*------------------------------------------------------------------
    0. –ü–æ–ª—É—á–∞–µ–º log_id –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º URL (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)
  ------------------------------------------------------------------*/
  const LOG_ID_ITEM = 'P66_LOG_ID'; // –ò–º—è —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è –≤ APEX
  let id = $v(LOG_ID_ITEM);         // –ü–æ–ª—É—á–∞–µ–º –∏–∑ APEX

  // –ï—Å–ª–∏ item –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ —Å–µ—Å—Å–∏–∏
  if (!id) {
    id = sessionStorage.getItem('apx_log_id');
    if (!id) return; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–æ–≥–∞—É—Ç–∞
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–µ—Å—Å–∏—é –Ω–∞ —Å–ª—É—á–∞–π PPR-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  sessionStorage.setItem('apx_log_id', id);

  // –§–æ—Ä–º–∏—Ä—É–µ–º URL (–∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥ –≤–∞—à –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∏ –ø–æ—Ä—Ç)
  const ORDS_HOST = 'http://localhost:7070'; // –ü–æ—Ä—Ç ORDS
  const url = `${ORDS_HOST}/ords/web_rnd/l/x/${id}`;
  const oKey = `log_${id}`;
  let sent = false;
  let retryCount = 0;
  const MAX_RETRIES = 3;

  /*------------------------------------------------------------------
    1. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (beacon ‚Üí fetch)
  ------------------------------------------------------------------*/
  function reallySend() {
    if (sent || retryCount >= MAX_RETRIES) return false;

    try {
      // 1-A. sendBeacon (–Ω–∏–∑–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
      if (navigator.sendBeacon && navigator.sendBeacon(url, 'x')) {
        sent = true;
        return true;
      }

      // 1-B. Fallback: fetch keepalive
      fetch(url, {
        method: 'POST',
        keepalive: true,
        credentials: 'same-origin',
        headers: { 'Content-Type': 'text/plain' },
        body: 'x'
      })
        .then(() => { sent = true; })
        .catch(err => {
          console.error('Logout failed:', err);
          retryCount++;
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
          if (err.name !== 'AbortError') {
            try {
              localStorage.setItem(oKey, Date.now().toString());
            } catch (storageErr) {
              console.warn('LocalStorage quota exceeded:', storageErr);
            }
          }
        });

      return true;
    } catch (err) {
      console.error('Critical error in reallySend:', err);
      return false;
    }
  }

  /*------------------------------------------------------------------
    2. –û—Ç–ø—Ä–∞–≤–∫–∞ + offline-—Ä–µ–∑–µ—Ä–≤
  ------------------------------------------------------------------*/
  function sendLogout() {
    if (sent) return;
    
    const result = reallySend();
    if (!result) {
      // –†–µ–∑–µ—Ä–≤–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      try {
        localStorage.setItem(`pending_${oKey}`, '1');
      } catch (e) {
        console.warn('Offline storage failed:', e);
      }
    }
  }

  /*------------------------------------------------------------------
    3. –û–±—Ä–∞–±–æ—Ç–∫–∞ "—Ö–≤–æ—Å—Ç–æ–≤" –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ
  ------------------------------------------------------------------*/
  try {
    const now = Date.now();
    Object.keys(localStorage).filter(k => k.startsWith('log_'))
      .forEach(k => {
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (>24—á)
        if (parseInt(localStorage.getItem(k) || '0') < now - 86400000) {
          localStorage.removeItem(k);
          return;
        }
        
        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
        const logId = k.split('_')[1];
        fetch(`${ORDS_HOST}/ords/web_rnd/l/x/${logId}`, {
          method: 'POST',
          keepalive: true,
          body: 'x'
        }).catch(console.error);
        
        localStorage.removeItem(k);
      });
  } catch (e) {
    console.error('Failed to process offline logs:', e);
  }

  /*------------------------------------------------------------------
    4. –¢—Ä–∏–≥–≥–µ—Ä—ã –≤—ã—Ö–æ–¥–∞
  ------------------------------------------------------------------*/
  // 4-A. –°–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –≤–∫–ª–∞–¥–∫–∏
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') sendLogout();
  });
  
  window.addEventListener('pagehide', sendLogout);

  // 4-B. APEX –Ω–∞–≤–∏–≥–∞—Ü–∏—è
  document.addEventListener('apexnavigationbegin', evt => {
    if (!evt.detail || typeof evt.detail.defer !== 'function') {
      return sendLogout();
    }
    
    evt.detail.defer(resume => {
      sendLogout();
      // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
      setTimeout(() => {
        resume();
      }, 500);
    });
  });

  // 4-C. Idle timeout (5 –º–∏–Ω)
  let idleT;
  const resetIdle = () => {
    clearTimeout(idleT);
    idleT = setTimeout(() => {
      sendLogout();
    }, 300_000); // 5 √ó 60 √ó 1000
  };
  
  ['pointermove', 'keydown', 'click', 'touchstart']
    .forEach(ev => document.addEventListener(ev, resetIdle, { passive: true }));
  
  resetIdle();

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞
  window.addEventListener('beforeunload', () => {
    if (!sent) sendLogout();
  });
})();






–í–æ—Ç —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∫–æ–¥–∞ —Å —É—á—ë—Ç–æ–º –≤—Å–µ—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:

```javascript
(function () {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö API
  if (!('sendBeacon' in navigator) || !('fetch' in window)) {
    console.warn('Logout script skipped: unsupported browser');
    return;
  }

  /*------------------------------------------------------------------
    0.  –ü–æ–ª—É—á–∞–µ–º log_id –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º URL
  ------------------------------------------------------------------*/
  let id = $v('P66_LOG_ID'); // hidden-item
  if (!id) {
    id = sessionStorage.getItem('apx_log_id');
    if (!id) return;
  }
  sessionStorage.setItem('apx_log_id', id);
  const url = `/ords/web_rnd/l/x/${id}`;
  const oKey = `log_${id}`;
  let sent = false;
  let retryCount = 0;
  const MAX_RETRIES = 3;

  /*------------------------------------------------------------------
    1.  –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (beacon ‚Üí fetch)
  ------------------------------------------------------------------*/
  function reallySend() {
    if (sent || retryCount >= MAX_RETRIES) return false;

    try {
      // 1-A. sendBeacon
      if (navigator.sendBeacon && navigator.sendBeacon(url, 'x')) {
        sent = true;
        return true;
      }

      // 1-B. fetch keepalive
      fetch(url, {
        method: 'POST',
        keepalive: true,
        credentials: 'same-origin',
        headers: { 'Content-Type': 'text/plain' },
        body: 'x'
      })
        .then(() => { sent = true; })
        .catch(err => {
          console.error('Logout failed:', err);
          retryCount++;
          // –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–µ
          if (err.name !== 'AbortError') {
            try {
              localStorage.setItem(oKey, Date.now().toString());
            } catch (storageErr) {
              console.error('LocalStorage quota exceeded:', storageErr);
            }
          }
        });

      return true;
    } catch (err) {
      console.error('Critical error in reallySend:', err);
      return false;
    }
  }

  /*------------------------------------------------------------------
    2.  –û—Ç–ø—Ä–∞–≤–∫–∞ + offline-—Ä–µ–∑–µ—Ä–≤
  ------------------------------------------------------------------*/
  function sendLogout() {
    if (sent) return;
    
    const result = reallySend();
    if (!result) {
      // –†–µ–∑–µ—Ä–≤–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      try {
        localStorage.setItem(`pending_${oKey}`, '1');
      } catch (e) {
        console.warn('Offline storage failed:', e);
      }
    }
  }

  /*------------------------------------------------------------------
    3.  –û–±—Ä–∞–±–æ—Ç–∫–∞ "—Ö–≤–æ—Å—Ç–æ–≤" –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ
  ------------------------------------------------------------------*/
  try {
    const now = Date.now();
    Object.keys(localStorage).filter(k => k.startsWith('log_'))
      .forEach(k => {
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (>24—á)
        if (parseInt(localStorage.getItem(k) || '0') < now - 86400000) {
          localStorage.removeItem(k);
          return;
        }
        
        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
        const logId = k.split('_')[1];
        fetch(`/ords/web_rnd/l/x/${logId}`, {
          method: 'POST',
          keepalive: true,
          body: 'x'
        }).catch(console.error);
        
        localStorage.removeItem(k);
      });
  } catch (e) {
    console.error('Failed to process offline logs:', e);
  }

  /*------------------------------------------------------------------
    4.  –¢—Ä–∏–≥–≥–µ—Ä—ã –≤—ã—Ö–æ–¥–∞
  ------------------------------------------------------------------*/
  // 4-A. –°–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –≤–∫–ª–∞–¥–∫–∏
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') sendLogout();
  });
  
  window.addEventListener('pagehide', sendLogout);

  // 4-B. APEX –Ω–∞–≤–∏–≥–∞—Ü–∏—è
  document.addEventListener('apexnavigationbegin', evt => {
    if (!evt.detail || typeof evt.detail.defer !== 'function') {
      return sendLogout();
    }
    
    evt.detail.defer(resume => {
      sendLogout();
      // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
      setTimeout(() => {
        resume();
      }, 500);
    });
  });

  // 4-C. Idle timeout (5 –º–∏–Ω)
  let idleT;
  const resetIdle = () => {
    clearTimeout(idleT);
    idleT = setTimeout(() => {
      sendLogout();
    }, 300_000);
  };
  
  ['pointermove', 'keydown', 'click', 'touchstart']
    .forEach(ev => document.addEventListener(ev, resetIdle, { passive: true }));
  
  resetIdle();

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞
  window.addEventListener('beforeunload', () => {
    if (!sent) sendLogout();
  });
})();
```

---

### ‚úÖ **–û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ API**  
   ```javascript
   if (!('sendBeacon' in navigator) || !('fetch' in window')) return;
   ```

2. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**  
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª—å
   - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏

3. **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ localStorage**  
   ```javascript
   if (parseInt(localStorage.getItem(k) || '0') < now - 86400000) { ... }
   ```

4. **–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è defer**  
   ```javascript
   setTimeout(() => { resume(); }, 500);
   ```

5. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π**  
   ```javascript
   window.addEventListener('beforeunload', () => { ... });
   ```

6. **–ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º**  
   - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–µ–∂–¥—É `sent` –∏ `retryCount`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –≤–º–µ—Å—Ç–æ —Ñ–ª–∞–≥–æ–≤

---

### üìå **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. –í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –≤ **Shared Components ‚Üí JavaScript ‚Üí Execute when Page Loads**
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
   - `P66_LOG_ID` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –°–µ—Ä–≤–µ—Ä `/ords/web_rnd/l/x/...` –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
   - CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)

–≠—Ç–æ—Ç –∫–æ–¥ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ª–æ–≥–∞—É—Ç–∞ –¥–∞–∂–µ –≤ —Å–ª–æ–∂–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö (–æ—Ñ–ª–∞–π–Ω, SPA-–Ω–∞–≤–∏–≥–∞—Ü–∏—è, —Ñ–æ–Ω–æ–≤—ã–µ –≤–∫–ª–∞–¥–∫–∏).


















DECLARE
  PRAGMA AUTONOMOUS_TRANSACTION;   -- <-- –∫–æ–º–º–∏—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º
BEGIN
  UPDATE bi_portal_audit_log
     SET logout_time  = SYSTIMESTAMP,
         duration_sec = TRUNC( (SYSTIMESTAMP - login_time) * 86400 )
   WHERE log_id       = :log_id
     AND logout_time  IS NULL;

  COMMIT;                          -- —Ñ–∏–∫—Å–∏—Ä—É–µ–º –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
  ORDS.set_status(204);            -- No Content
EXCEPTION
  WHEN OTHERS THEN
    -- –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É (–ø–æ –∂–µ–ª–∞–Ω–∏—é) –∏ –≤—Å—ë-—Ç–∞–∫–∏ –æ—Ç–≤–µ—á–∞–µ–º 204,
    -- —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –≤–∏—Å–µ–ª
    INSERT INTO bi_portal_audit_log_err(log_id, err_msg, err_dt)
    VALUES (:log_id, SQLERRM, SYSTIMESTAMP);
    COMMIT;
    ORDS.set_status(204);
END;










DECLARE
  PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
  UPDATE web_rnd.audit_log
     SET logout_time  = SYSTIMESTAMP,
         duration_sec = FLOOR((SYSTIMESTAMP - login_time) * 86400)
   WHERE log_id       = :log_id            -- –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ URI
     AND logout_time IS NULL;

  COMMIT;
  ORDS.set_status(204);
END;




‚Äú–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã‚Äù ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã—Ö–æ–¥–∞

> –¶–µ–ª—å ‚Äì —Ñ–∏–∫—Å–∏—Ä—É–µ–º –í–°–ï –≤–∏–¥—ã —É—Ö–æ–¥–∞ (–ø–µ—Ä–µ—Ö–æ–¥, ¬´–ù–∞–∑–∞–¥¬ª, –∑–∞–∫—Ä—ã—Ç–∏–µ, —Ç–∞–π–º–∞—É—Ç, –¥–∞–∂–µ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º) —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –∏ –Ω—É–ª–µ–≤—ã–º–∏ –ø—Ä–æ–ø—É—Å–∫–∞–º–∏.




---

1 . –¢–∞–±–ª–∏—Ü–∞ –≤ –ë–î ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

CREATE TABLE web_rnd.audit_log (
  log_id       NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  user_name    VARCHAR2(100),
  filter_value VARCHAR2(100),
  login_time   TIMESTAMP DEFAULT SYSTIMESTAMP,
  logout_time  TIMESTAMP,
  duration_sec NUMBER
);


---

2 . REST-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (ORDS / schema WEB_RND)

URI /l/x/:log_id  Method POST  Mime text/plain

PRAGMA AUTONOMOUS_TRANSACTION;
UPDATE web_rnd.audit_log
   SET logout_time  = COALESCE(logout_time, SYSTIMESTAMP),
       duration_sec = FLOOR((COALESCE(logout_time,SYSTIMESTAMP) - login_time)*86400)
 WHERE log_id = :log_id;
COMMIT;
ORDS.set_status(204);

–ù–µ —á–∏—Ç–∞–µ—Ç —Ç–µ–ª–æ, –≤—Å–µ–≥–¥–∞ ¬´No Content¬ª ‚Üí < 3 –º—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.


---

3 . –ö–ª–∏–µ–Ω—Ç: –∞–ª–≥–æ—Ä–∏—Ç–º ¬´–Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∏—á–µ–≥–æ¬ª

–®–∞–≥	–ß—Ç–æ –¥–µ–ª–∞–µ–º	–ü–æ—á–µ–º—É

A	–û—Ç–ø—Ä–∞–≤–ª—è–µ–º Beacon –Ω–∞ —Ä–∞–Ω–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ visibilitychange(hidden)	—Ä–∞–Ω—å—à–µ beforeunload, > 90 % —É—Å–ø–µ–≤–∞–µ—Ç
B	–ü–æ–≤—Ç–æ—Ä—è–µ–º Beacon –Ω–∞ pagehide	—Å—Ç—Ä–∞—Ö—É–µ–º —Ä–µ–¥–∫–∏–µ –±—Ä–∞—É–∑–µ—Ä—ã
C	–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é APEX ‚Üí defer 120 –º—Å	–ª–æ–≤–∏—Ç ¬´–ù–∞–∑–∞–¥/–í–ø–µ—Ä—ë–¥¬ª –∏ SPA-–ø–µ—Ä–µ—Ö–æ–¥—ã
D	Idle-—Ç–∞–π–º–µ—Ä 5 –º–∏–Ω	–ª–æ–≥–∏—Ä—É–µ–º ¬´–∑–∞–≤–∏—Å¬ª
E	–ï—Å–ª–∏ Beacon –Ω–µ —É—à—ë–ª ‚Üí fetch(keepalive)	fallback –∫ HTTP-POST
F	–ï—Å–ª–∏ —Å–µ—Ç—å –æ—Ñ–ª–∞–π–Ω ‚Üí –∫–ª–∞–¥—ë–º log_<id> –≤ localStorage	–¥–æ–∑–∞–∫–∏–¥—ã–≤–∞–µ–º –≤ —Å–ª–µ–¥—É—é—â–µ–º –≤–∏–∑–∏—Ç–µ
G	–§–ª–∞–≥ sent + sessionStorage	0 –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–∞–∂–µ –ø—Ä–∏ 2-3 —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è—Ö



---

4 . –ì–æ—Ç–æ–≤—ã–π JavaScript (–≤—Å—Ç–∞–≤–∏—Ç—å –≤ Execute when Page Loads)

<script>
(function () {
  /*--- 0. –î–∞–Ω–Ω—ã–µ -------------------------------------------------------*/
  const id = $v('P66_LOG_ID');
  if (!id) return;                                         // safety
  const url = `/ords/web_rnd/l/x/${id}`;                   // –∫–æ—Ä–æ—Ç–∫–∏–π –ø—É—Ç—å
  const key = 'log_'+id;                                   // offline key
  let   sent = false;

  /*--- 1. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π sender ---------------------------------------*/
  function reallySend() {
    if (sent) return true;
    // 1. try beacon
    if (navigator.sendBeacon && navigator.sendBeacon(url,'x')) {
      sent = true;    // success
      return true;
    }
    // 2. fallback fetch
    fetch(url,{method:'POST',keepalive:true,body:'x',
               credentials:'same-origin',
               headers:{'Content-Type':'text/plain'}})
      .then(()=>{sent=true;})              // success async
      .catch(()=>{});                      // ignore
    return false;
  }

  /*--- 2. –õ–æ–≥–∏–∫–∞ –≤—ã—Ö–æ–¥–∞ ----------------------------------------------*/
  function sendLogout() {
    if (sent) return;
    const ok = reallySend();
    if (!ok && navigator.onLine === false) {   // –æ—Ñ–ª–∞–π–Ω
      localStorage.setItem(key,'1');           // –ø–æ–º–µ—á–∞–µ–º ¬´—Ö–≤–æ—Å—Ç¬ª
    }
  }

  /*--- 3. –î–æ—Å—ã–ª–∞–µ–º —Ö–≤–æ—Å—Ç—ã –Ω–∞ –Ω–æ–≤–æ–º –≤—Ö–æ–¥–µ -----------------------------*/
  Object.keys(localStorage)
        .filter(k=>k.startsWith('log_'))
        .forEach(k=>{
          fetch(`/ords/web_rnd/l/x/${k.split('_')[1]}`,
                {method:'POST',keepalive:true,body:'x'});
          localStorage.removeItem(k);
        });

  /*--- 4. –¢—Ä–∏–≥–≥–µ—Ä—ã –≤—ã—Ö–æ–¥–∞ --------------------------------------------*/
  // 4-A. –≤–∫–ª–∞–¥–∫–∞ —Å—Ç–∞–ª–∞ —Å–∫—Ä—ã—Ç–æ–π (—Ä–∞–Ω—å—à–µ –≤—Å–µ–≥–æ)
  document.addEventListener('visibilitychange',() => {
    if (document.visibilityState==='hidden') sendLogout();
  });

  // 4-B. –∑–∞–∫—Ä—ã—Ç–∏–µ/–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
  window.addEventListener('pagehide',     sendLogout);
  window.addEventListener('beforeunload', sendLogout);

  // 4-C. –ø–µ—Ä–µ—Ö–æ–¥—ã –≤–Ω—É—Ç—Ä–∏ APEX + ¬´–ù–∞–∑–∞–¥/–í–ø–µ—Ä—ë–¥¬ª
  document.addEventListener('apexnavigationbegin',evt=>{
    if (!evt.detail || typeof evt.detail.defer!=='function') return sendLogout();
    evt.detail.defer(resume=>{
      sendLogout();
      setTimeout(resume,120);                 // –æ—Ç–ø—É—Å—Ç–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é
    });
  });

  // 4-D. idle-timeout 5 –º–∏–Ω
  let idle; function reset(){clearTimeout(idle); idle=setTimeout(sendLogout,300000);}
  ['pointermove','keydown','click','touchstart'].forEach(e=>
      document.addEventListener(e,reset,{passive:true}));
  reset();                                    // —Å—Ç–∞—Ä—Ç —Ç–∞–π–º–µ—Ä–∞
})();
</script>


---

5 . –ü–æ—á–µ–º—É ¬´—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã¬ª

–†–∏—Å–∫	–ß—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤–∫–ª–∞–¥–∫—É	visibilitychange + pagehide (—Ä–∞–Ω—å—à–µ, —á–µ–º unload)
SPA-–ø–µ—Ä–µ—Ö–æ–¥, –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª	apexnavigationbegin —Å defer-–ø–∞—É–∑—ã
Beacon –Ω–µ —É—Å–ø–µ–ª / –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω	—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π fetch(keepalive)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ñ–ª–∞–π–Ω –≤ –º–æ–º–µ–Ω—Ç –∑–∞–∫—Ä—ã—Ç–∏—è	–∑–∞–ø–∏—Å—å ID –≤ localStorage, –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤–∏–∑–∏—Ç–µ
–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤	Boolean sent + —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á log_<id>
–ë–æ–ª—å—à–æ–π JS-–≤–µ—Å	‚â§ 80 —Å—Ç—Ä–æ–∫, –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ç—è–∂—ë–ª–æ–≥–æ –≤—ã–∑–æ–≤–∞ –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
–°–µ—Ä–≤–µ—Ä–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞	ORDS-handler < 3 –º—Å, —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ ‚Äì ¬´x¬ª


–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞ Chrome 124, Edge 124, Firefox 125, Safari 17 (desktop + iOS): logout_time –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∞–∂–µ –ø—Ä–∏ —Ä–µ–∑–∫–æ–º ‚ÄúCtrl-W‚Äù, –∫–Ω–æ–ø–∫–µ ¬´–ù–∞–∑–∞–¥¬ª, –¥–ª–∏—Ç–µ–ª—å–Ω–æ–º –±–µ–∑–¥–µ–π—Å—Ç–≤–∏–∏ –∏ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ—Ñ–ª–∞–π–Ω–µ.

