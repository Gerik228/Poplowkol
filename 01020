Вот краткий принцип работы твоей системы логирования:


---

1. При входе на страницу

APEX-процесс вставляет строку в таблицу AUDIT_LOG:

log_id

user_name

filter_value

login_time = SYSTIMESTAMP


log_id сохраняется в скрытый элемент P66_LOG_ID.



---

2. JavaScript на клиенте

Сохраняет log_id, собирает URL REST-запроса.

Отслеживает 4 типа событий:

1. Закрытие страницы: pagehide, beforeunload


2. Скрытие вкладки: visibilitychange


3. Переход внутри APEX (в т.ч. кнопка «Назад»): apexnavigationbegin
→ Приостанавливает переход на 120 мс, чтобы успел сработать sendBeacon


4. Таймаут 5 мин неактивности: срабатывает, если нет действий



sendLogout():

Отправляет navigator.sendBeacon('/ords/.../log-logout/' + log_id)

Отправка происходит только один раз (флаг sent)




---

3. ORDS REST handler (на сервере)

Принимает POST /log-logout/:log_id

Обновляет строку:

logout_time = SYSTIMESTAMP

duration_sec = (logout_time - login_time) * 86400




---

Итог

Каждый визит фиксируется как:

вход (в момент загрузки страницы)

выход (в момент ухода, без лишних вызовов)

Всё устойчиво даже при:

закрытии вкладки

переключении страницы

навигации «Назад»

бездействии



Система полностью работает в фоновом режиме, надёжна и быстра.

