### **Итоговая реализация логирования входа/выхода в APEX 23.1**

---

#### **1. Таблица логов**
```sql
-- Создание таблицы
CREATE TABLE page_visit_log (
    log_id          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username        VARCHAR2(255),
    item_value      VARCHAR2(4000),
    login_time      TIMESTAMP,
    logout_time     TIMESTAMP
);

-- Индексы для производительности
CREATE INDEX idx_username ON page_visit_log(username);
CREATE INDEX idx_item_value ON page_visit_log(item_value);
```

---

#### **2. PL/SQL пакет для обновления лога**
```sql
-- Пакет
CREATE OR REPLACE PACKAGE apex_log_pkg IS
    PROCEDURE update_logout_time (
        p_username   IN VARCHAR2,
        p_item_value IN VARCHAR2
    );
END;

-- Тело пакета
CREATE OR REPLACE PACKAGE BODY apex_log_pkg IS
    PROCEDURE update_logout_time (
        p_username   IN VARCHAR2,
        p_item_value IN VARCHAR2
    ) IS
    BEGIN
        UPDATE page_visit_log
        SET logout_time = SYSTIMESTAMP
        WHERE username = p_username
          AND item_value = p_item_value
          AND logout_time IS NULL;
    END;
END;
```

---

#### **3. RESTful Service (ORDS)**
**Путь:** `/log-logout`  
**Метод:** `POST`  
**Настройки:**
- **Authentication:** `None` (для тестирования)
- **MIME Types Allowed:** `application/json`
- **PL/SQL Source:**
```plsql
DECLARE
    l_body CLOB := :body_text;
    l_username VARCHAR2(255);
    l_item_value VARCHAR2(4000);
BEGIN
    -- Парсинг JSON из тела запроса
    l_username := JSON_VALUE(l_body, '$.username');
    l_item_value := JSON_VALUE(l_body, '$.itemValue');

    -- Обновление лога
    apex_log_pkg.update_logout_time(
        p_username => l_username,
        p_item_value => l_item_value
    );

    -- Ответ 204 No Content
    ORDS.SET_STATUS(204);
END;
```

---

#### **4. JavaScript для отслеживания выхода**
Добавьте в `Page Attributes → JavaScript → Execute when Page Loads`:
```javascript
(function() {
    const ITEM_NAME = "P66_IFRAME_ID"; // Замените на ваш Item
    const USERNAME = "#APP_USER";

    function sendLogoutRequest(trigger) {
        const payload = {
            username: USERNAME,
            itemValue: apex.item(ITEM_NAME).getValue(),
            trigger: trigger
        };

        // Приоритет: fetch с keepalive
        fetch('/ords/web_rnd/log/log-logout', {
            method: 'POST',
            body: JSON.stringify(payload),
            keepalive: true,
            headers: {'Content-Type': 'application/json'}
        }).catch(() => {
            // Резерв: navigator.sendBeacon
            const beacon = new Blob([JSON.stringify(payload)], {type: 'application/json'});
            navigator.sendBeacon('/ords/web_rnd/log/log-logout', beacon);
        });
    }

    // Событие закрытия вкладки/браузера
    window.addEventListener('beforeunload', () => {
        sendLogoutRequest('beforeunload');
    });

    // Событие скрытия страницы (переключение вкладок)
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
            sendLogoutRequest('visibilitychange');
        }
    });

    // Обработка навигации в APEX
    $(document).on('apexafterclosedialog apexafterrefresh', () => {
        sendLogoutRequest('apex_navigation');
    });
})();
```

---

#### **5. Логирование входа**
**Page Process → Page Load:**
```plsql
INSERT INTO page_visit_log (username, item_value, login_time)
VALUES (
    v('APP_USER'), 
    :P66_IFRAME_ID, -- Замените на ваш Item
    SYSTIMESTAMP
);
```

---

### **Тестирование**
1. **Вход на страницу:**
   - Откройте страницу → Проверьте запись в `page_visit_log`.
2. **Выход:**
   - Закройте вкладку/перейдите на другую страницу → Проверьте обновление `logout_time`.
3. **Ошибка CORS:**
   - Убедитесь, что URL в `fetch` и `sendBeacon` совпадает с доменом APEX.
4. **ORDS:**
   - Проверьте, что RESTful Service доступен без ошибок (статус 204).

---

### **Важные замечания**
- **Безопасность:** Для production-среды настройте OAuth 2.0 или JWT в RESTful Service.
- **Safari:** Используйте `navigator.sendBeacon` без `Blob`, если возникают ошибки:
  ```javascript
  navigator.sendBeacon('/ords/web_rnd/log/log-logout', 'username=' + USERNAME + '&itemValue=' + apex.item(ITEM_NAME).getValue());
  ```
- **Логирование ошибок:** Добавьте таблицу `error_log` для отладки:
  ```sql
  CREATE TABLE error_log (id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, message CLOB, log_time TIMESTAMP);
  ```