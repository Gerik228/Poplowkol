Полная, пошаговая инструкция

Как организовать журнал «зашёл / ушёл» на одной странице APEX 23.1 (ORDS 23.1.3)

> Результат — в таблице PAGE_VISIT_LOG увидите:
LOG_ID | USERNAME | ITEM_VALUE | LOGIN_TIME | LOGOUT_TIME




---

ШАГ 0 Проверяем минимум

Должно быть	Проверка

ORDS установлен	SELECT ords.installed_version FROM dual; (получили 23.1.3…)
Ваша схема уже в ORDS	SELECT * FROM user_ords_enabled_schemas; — ENABLED


Схема не включена? выполните один раз:

BEGIN
  ORDS.enable_schema(
    p_schema              => 'WEB_RND',        -- ← ваша схема
    p_url_mapping_type    => 'BASE_PATH',
    p_url_mapping_pattern => 'web_rnd',        -- впишется в URL
    p_auto_rest_auth      => FALSE);
END;
/


---

ШАГ 1 Создаём таблицу-журнал

CREATE TABLE page_visit_log (
  log_id      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  username    VARCHAR2(255),
  item_value  VARCHAR2(4000),
  login_time  TIMESTAMP DEFAULT SYSTIMESTAMP,
  logout_time TIMESTAMP
);


---

ШАГ 2 Правим страницу-шаблон

1. Добавьте 2 скрытых page-item’а

P_LOG_ID (hidden)

P_ITEM_VAL (hidden) – если нужно тащить сам фильтр



2. Процесс “Log IN” Point → Before Header



:P_ITEM_VAL := :P66_IFRAME_ID;          -- ваш фильтр-item

INSERT INTO page_visit_log(username, item_value, login_time)
VALUES (:APP_USER, :P_ITEM_VAL, SYSTIMESTAMP)
RETURNING log_id INTO :P_LOG_ID;

COMMIT;


---

ШАГ 3 REST-точка, которая ставит logout_time

3.1 Создаём модуль, шаблон, обработчик

SQL Workshop → RESTful Services (ORDS Based)

Экран	Параметры

Create Module	Name LOG_AUDIT  Base Path /log/  Is Published ON
Create Template	URI Template log-logout/:log_id
Create Handler	Method POST Source Type PL/SQL MIME text/plain


PL/SQL-код обработчика:

BEGIN
  UPDATE page_visit_log
     SET logout_time = SYSTIMESTAMP
   WHERE log_id      = :log_id
     AND logout_time IS NULL;
  COMMIT;
  ORDS.set_status(204);          -- No Content
END;

> Полный URL получится
…/ords/web_rnd/log/log-logout/:log_id



3.2 (Опционально) закрываем точку от посторонних

В модуле → Actions ▼ → Create Privilege

Pattern /log/*

Authentication → Application Express



---

ШАГ 4 JavaScript на странице

Page Designer → JavaScript → Execute when Page Loads

(function () {
  if (window._logoutHookAdded) return;
  window._logoutHookAdded = true;

  function sendLogout() {
    if (window._logoutSent) return;
    window._logoutSent = true;

    const id = $v('P_LOG_ID');
    if (!id) return;

    const url = '/ords/web_rnd/log/log-logout/' + id;
    navigator.sendBeacon(url, new Blob(['x'], {type: 'text/plain'}));
  }

  /* 1 – закрытие вкладки / браузера */
  window.addEventListener('beforeunload', sendLogout);

  /* 2 – APEX-навигация без reload (модалки, partial refresh) */
  $(document).on('apexafterclosedialog apexafterrefresh', sendLogout);

  /* 3 – вкладка стала скрытой → можно считать уходом */
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') sendLogout();
  });
})();

**Почему Blob(['x'], 'text/plain')?** sendBeacon` обязан послать хоть какое-то тело, JSON не нужен.


---

ШАГ 5 Тест

1. DevTools → Network → фильтр log-logout


2. Открываете страницу:
В таблице появляется строка, logout_time = NULL.


3. Закрываете вкладку / переходите дальше →
В Network фиксируется POST /…/log-logout/<ID> → 204.
logout_time в таблице заполнился.



SELECT log_id, username, item_value, login_time, logout_time
  FROM page_visit_log
 ORDER BY log_id DESC FETCH FIRST 5 ROWS ONLY;


---

ШАГ 6 Чистка старого лога (по желанию)

CREATE OR REPLACE PROCEDURE purge_old_visits IS
BEGIN
  DELETE FROM page_visit_log
   WHERE login_time < SYSTIMESTAMP - 30;  -- 30 дней
  COMMIT;
END;
/

BEGIN
  DBMS_SCHEDULER.create_job(
    job_name        => 'PURGE_VISITS',
    job_type        => 'PLSQL_BLOCK',
    job_action      => 'BEGIN purge_old_visits; END;',
    repeat_interval => 'FREQ=DAILY;BYHOUR=3',
    enabled         => TRUE);
END;
/


---

Частые ошибки и решения

Ошибка	Причина / исправление

404 при POST	Base Path или URI Template описаны не так; проверьте URL в свойствах шаблона.
401 / 403	Модуль защищён, а запрос не содержит cookie APEX (тестировали в отдельной вкладке / другом домене).
Beacon не уходит	P_LOG_ID пуст (проверьте процесс Log IN) или скрипт не привязан (не в Page Loads).
JSON-тело → preflight OPTIONS	Оставьте text/plain; sendBeacon не дружит с application/json.



---

Всё — система журналирования готова

Каждое открытие страницы порождает строку login_time, а событие закрытия/ухода надежно проставляет logout_time. Всё работает на чистом APEX 23.1+ORDS 23.1.3 и не требует сторонних плагинов.

