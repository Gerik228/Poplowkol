// Проверяем наличие html2canvas
if (typeof html2canvas !== 'function') {
  apex.message.alert('html2canvas не загружен!');
  throw new Error('html2canvas not found');
}

// Селектор региона с iframe (замените на ваш)
const selector = '#YOUR_REGION_STATIC_ID';

// Делает iframe «высоким» для полного захвата
function expandIframes(root) {
  root.querySelectorAll('iframe').forEach(iframe => {
    try {
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      const h = Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight);
      iframe.style.height = h + 'px';
      iframe.style.overflow = 'visible';
    } catch(e) {
      console.warn('Cross-origin iframe, пропускаем');
    }
  });
}

// Сам скрипт захвата и скачивания
(async () => {
  apex.util.showSpinner($('#BTN_SCREENSHOT'));
  expandIframes(document.querySelector(selector));
  // Небольшая задержка, чтобы iframe успел перерисоваться
  await new Promise(r => setTimeout(r, 300));
  try {
    const canvas = await html2canvas(document.querySelector(selector), {
      useCORS: true,
      allowTaint: true,
      scrollX: 0,
      scrollY: 0
    });
    // Создаём ссылку для скачивания
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = 'screenshot_' + Date.now() + '.png';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    apex.message.showPageSuccess('Скриншот сохранён в «Загрузки»');
  } catch(e) {
    apex.message.alert('Ошибка создания скриншота: ' + e.message);
  } finally {
    apex.util.hideSpinner($('#BTN_SCREENSHOT'));
  }
})();