DECLARE
  l_session     DBMS_LDAP.SESSION;
  l_retval      PLS_INTEGER;
  l_message     DBMS_LDAP.MESSAGE;
  l_entry       DBMS_LDAP.MESSAGE;
  l_dn          VARCHAR2(2000);
  l_username    VARCHAR2(500);
  l_count       PLS_INTEGER := 0;
  l_group_count PLS_INTEGER := 0;
  
BEGIN
  -- Подключение к AD
  l_session := DBMS_LDAP.init('', 389);
  l_retval := DBMS_LDAP.simple_bind_s(
    l_session,
    '',
    ''
  );
  
  IF l_retval = 0 THEN
    
    -- ========== СИНХРОНИЗАЦИЯ ПОЛЬЗОВАТЕЛЕЙ ==========
    -- Очищаем старые данные
    DELETE FROM AD_SYNC_SERVICE.AD_USERS;
    COMMIT;
    
    -- Ищем пользователей используя обычный search
    l_retval := DBMS_LDAP.search(
      l_session,
      '',
      DBMS_LDAP.SCOPE_SUBTREE,
      '(objectClass=person)',
      NULL,
      FALSE,
      l_message
    );
    
    IF l_retval = 0 THEN
      l_entry := DBMS_LDAP.first_entry(l_session, l_message);
      
      WHILE l_entry IS NOT NULL LOOP
        -- Получаем только DN (без атрибутов чтобы избежать ошибок)
        l_dn := DBMS_LDAP.get_dn(l_session, l_entry);
        
        -- Извлекаем username из DN (часть после CN=)
        IF INSTR(l_dn, 'CN=') > 0 THEN
          l_username := SUBSTR(l_dn, INSTR(l_dn, 'CN=') + 3);
          l_username := SUBSTR(l_username, 1, INSTR(l_username || ',', ',') - 1);
        ELSE
          l_username := 'Unknown';
        END IF;
        
        -- Вставляем в таблицу (упрощенная версия)
        INSERT INTO AD_SYNC_SERVICE.AD_USERS (
          user_dn, 
          username, 
          email, 
          created_date
        ) VALUES (
          SUBSTR(l_dn, 1, 500),  -- обрезаем до размера колонки
          SUBSTR(l_username, 1, 100),
          NULL,  -- email пока NULL, так как get_values не работает
          SYSDATE
        );
        
        l_count := l_count + 1;
        l_entry := DBMS_LDAP.next_entry(l_session, l_entry);
      END LOOP;
    END IF;
    
    COMMIT;
    
    -- ========== СИНХРОНИЗАЦИЯ ГРУПП ==========
    DELETE FROM AD_SYNC_SERVICE.AD_GROUPS;
    COMMIT;
    
    l_retval := DBMS_LDAP.search(
      l_session,
      '',
      DBMS_LDAP.SCOPE_SUBTREE,
      '(objectClass=group)',
      NULL,
      FALSE,
      l_message
    );
    
    IF l_retval = 0 THEN
      l_entry := DBMS_LDAP.first_entry(l_session, l_message);
      
      WHILE l_entry IS NOT NULL LOOP
        l_dn := DBMS_LDAP.get_dn(l_session, l_entry);
        
        -- Извлекаем имя группы из DN
        IF INSTR(l_dn, 'CN=') > 0 THEN
          l_username := SUBSTR(l_dn, INSTR(l_dn, 'CN=') + 3);
          l_username := SUBSTR(l_username, 1, INSTR(l_username || ',', ',') - 1);
        ELSE
          l_username := 'Unknown';
        END IF;
        
        INSERT INTO AD_SYNC_SERVICE.AD_GROUPS (
          group_dn,
          group_name,
          created_date
        ) VALUES (
          SUBSTR(l_dn, 1, 500),
          SUBSTR(l_username, 1, 100),
          SYSDATE
        );
        
        l_group_count := l_group_count + 1;
        l_entry := DBMS_LDAP.next_entry(l_session, l_entry);
      END LOOP;
    END IF;
    
    COMMIT;
    
    -- Выводим результат (если DBMS_OUTPUT работает)
    BEGIN
      DBMS_OUTPUT.PUT_LINE('Users: ' || l_count || ', Groups: ' || l_group_count);
    EXCEPTION
      WHEN OTHERS THEN NULL;
    END;
    
  END IF;
  
  DBMS_LDAP.unbind_s(l_session);
  
EXCEPTION
  WHEN OTHERS THEN
    ROLLBACK;
    IF l_session IS NOT NULL THEN
      BEGIN
        DBMS_LDAP.unbind_s(l_session);
      EXCEPTION WHEN OTHERS THEN NULL;
      END;
    END IF;
    RAISE;
END;
/
