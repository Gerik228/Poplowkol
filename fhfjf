DECLARE
  l_session  DBMS_LDAP.SESSION;
  l_retval   PLS_INTEGER;
BEGIN
  -- Проверяем текущего пользователя
  DBMS_OUTPUT.ENABLE(1000000);
  DBMS_OUTPUT.PUT_LINE('Current user: ' || USER);
  
  -- Инициализация LDAP сессии
  BEGIN
    l_session := DBMS_LDAP.init('YOUR_AD_SERVER_NAME', 389);
    DBMS_OUTPUT.PUT_LINE('LDAP init: SUCCESS');
  EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('LDAP init: FAILED - ' || SQLERRM);
      RETURN;
  END;
  
  -- Подключение под сервисным аккаунтом
  BEGIN
    l_retval := DBMS_LDAP.simple_bind_s(
      l_session,
      'CN=YOUR_SERVICE_ACCOUNT,OU=YOUR_SERVICE_OU,OU=YOUR_PARENT_OU,DC=your_domain,DC=local',
      'YOUR_PASSWORD_HERE'
    );
    
    IF l_retval = 0 THEN
      DBMS_OUTPUT.PUT_LINE('BIND: SUCCESS - Connection to AD established!');
      DBMS_OUTPUT.PUT_LINE('Your AD connection is working correctly.');
      DBMS_OUTPUT.PUT_LINE('You can now configure your sync job with these parameters.');
    ELSE
      DBMS_OUTPUT.PUT_LINE('BIND: FAILED - Return code: ' || l_retval);
      CASE l_retval
        WHEN 49 THEN DBMS_OUTPUT.PUT_LINE('Error: Invalid credentials (username/password)');
        WHEN 32 THEN DBMS_OUTPUT.PUT_LINE('Error: No such object (DN not found)');
        WHEN 34 THEN DBMS_OUTPUT.PUT_LINE('Error: Invalid DN syntax');
        ELSE DBMS_OUTPUT.PUT_LINE('Error: Unknown LDAP error code');
      END CASE;
    END IF;
    
  EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('BIND: EXCEPTION - ' || SQLERRM);
  END;
  
  -- Закрываем сессию
  BEGIN
    DBMS_LDAP.unbind_s(l_session);
    DBMS_OUTPUT.PUT_LINE('Session closed successfully');
  EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('Warning: Error closing session - ' || SQLERRM);
  END;
  
EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('FATAL ERROR: ' || SQLERRM);
    IF l_session IS NOT NULL THEN
      BEGIN
        DBMS_LDAP.unbind_s(l_session);
      EXCEPTION WHEN OTHERS THEN NULL;
      END;
    END IF;
END;
/
