DECLARE
  l_session     DBMS_LDAP.SESSION;
  l_retval      PLS_INTEGER;
  l_message     DBMS_LDAP.MESSAGE;
  l_entry       DBMS_LDAP.MESSAGE;
  l_dn          VARCHAR2(2000);
  l_cn          VARCHAR2(500);
  l_email       VARCHAR2(500);
  l_values      DBMS_LDAP.STRING_ARRAY;
  l_count       PLS_INTEGER := 0;
  l_group_count PLS_INTEGER := 0;
  
BEGIN
  -- Подключение к AD
  l_session := DBMS_LDAP.init('', 389);
  l_retval := DBMS_LDAP.simple_bind_s(
    l_session,
    'CN=',
    ''
  );
  
  IF l_retval = 0 THEN
    
    -- ========== СИНХРОНИЗАЦИЯ ПОЛЬЗОВАТЕЛЕЙ ==========
    -- Очищаем старые данные
    DELETE FROM AD_SYNC_SERVICE.AD_USERS;
    COMMIT;
    
    -- Ищем пользователей используя обычный search (НЕ search_s)
    l_retval := DBMS_LDAP.search(
      l_session,
      'OU=,DC=,DC=',
      DBMS_LDAP.SCOPE_SUBTREE,
      '(objectClass=person)',
      NULL,
      FALSE,
      l_message
    );
    
    IF l_retval = 0 THEN
      l_entry := DBMS_LDAP.first_entry(l_session, l_message);
      
      WHILE l_entry IS NOT NULL LOOP
        -- Получаем DN
        l_dn := DBMS_LDAP.get_dn(l_session, l_entry);
        
        -- Получаем CN (Common Name)
        l_values := DBMS_LDAP.get_values(l_session, l_entry, 'cn');
        IF l_values IS NOT NULL AND l_values.COUNT > 0 THEN
          l_cn := l_values(l_values.FIRST);
        ELSE
          l_cn := NULL;
        END IF;
        
        -- Получаем Email
        l_values := DBMS_LDAP.get_values(l_session, l_entry, 'mail');
        IF l_values IS NOT NULL AND l_values.COUNT > 0 THEN
          l_email := l_values(l_values.FIRST);
        ELSE
          l_email := NULL;
        END IF;
        
        -- Вставляем в таблицу
        INSERT INTO AD_SYNC_SERVICE.AD_USERS (
          user_dn, 
          username, 
          email, 
          created_date
        ) VALUES (
          l_dn,
          l_cn,
          l_email,
          SYSDATE
        );
        
        l_count := l_count + 1;
        l_entry := DBMS_LDAP.next_entry(l_session, l_entry);
      END LOOP;
    END IF;
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Users synchronized: ' || l_count);
    
    -- ========== СИНХРОНИЗАЦИЯ ГРУПП ==========
    -- Очищаем старые группы
    DELETE FROM AD_SYNC_SERVICE.AD_GROUPS;
    COMMIT;
    
    -- Ищем группы
    l_retval := DBMS_LDAP.search(
      l_session,
      'OU=,DC=,DC=',
      DBMS_LDAP.SCOPE_SUBTREE,
      '(objectClass=group)',
      NULL,
      FALSE,
      l_message
    );
    
    IF l_retval = 0 THEN
      l_entry := DBMS_LDAP.first_entry(l_session, l_message);
      
      WHILE l_entry IS NOT NULL LOOP
        -- Получаем DN группы
        l_dn := DBMS_LDAP.get_dn(l_session, l_entry);
        
        -- Получаем CN группы
        l_values := DBMS_LDAP.get_values(l_session, l_entry, 'cn');
        IF l_values IS NOT NULL AND l_values.COUNT > 0 THEN
          l_cn := l_values(l_values.FIRST);
        ELSE
          l_cn := NULL;
        END IF;
        
        -- Вставляем группу
        INSERT INTO AD_SYNC_SERVICE.AD_GROUPS (
          group_dn,
          group_name,
          created_date
        ) VALUES (
          l_dn,
          l_cn,
          SYSDATE
        );
        
        l_group_count := l_group_count + 1;
        l_entry := DBMS_LDAP.next_entry(l_session, l_entry);
      END LOOP;
    END IF;
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Groups synchronized: ' || l_group_count);
    DBMS_OUTPUT.PUT_LINE('Synchronization completed successfully!');
    
  ELSE
    DBMS_OUTPUT.PUT_LINE('LDAP Bind failed: ' || l_retval);
  END IF;
  
  -- Закрываем сессию
  DBMS_LDAP.unbind_s(l_session);
  
EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
    ROLLBACK;
    IF l_session IS NOT NULL THEN
      BEGIN
        DBMS_LDAP.unbind_s(l_session);
      EXCEPTION WHEN OTHERS THEN NULL;
      END;
    END IF;
END;
/
