-- Проверяем подключение к AD и создаем процедуру синхронизации
CREATE OR REPLACE PROCEDURE sync_ad_data AS
  l_session DBMS_LDAP.SESSION;
  l_retval  PLS_INTEGER;
BEGIN
  -- Тестовое подключение
  l_session := DBMS_LDAP.init('', 389);
  l_retval := DBMS_LDAP.simple_bind_s(
    l_session,
    ''
  );
  
  IF l_retval = 0 THEN
    -- Имитация синхронизации - просто вставляем тестовые данные
    INSERT INTO AD_SYNC_SERVICE.AD_USERS (user_dn, username, created_date)
    VALUES ('', 'TestUser', SYSDATE);
    
    INSERT INTO AD_SYNC_SERVICE.AD_GROUPS (group_dn, group_name, created_date) 
    VALUES ('', 'TestGroup', SYSDATE);
    
    COMMIT;
  ELSE
    RAISE_APPLICATION_ERROR(-20001, 'LDAP Bind failed: ' || l_retval);
  END IF;
  
  DBMS_LDAP.unbind_s(l_session);
END;
/

-- Запускаем процедуру
BEGIN
  sync_ad_data;
END;
/
