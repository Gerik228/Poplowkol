
CREATE TABLE ad_users (
  -- –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¢–û–†–´
  user_id             VARCHAR2(100) PRIMARY KEY,
  sam_account_name    VARCHAR2(256) UNIQUE NOT NULL,
  distinguished_name  VARCHAR2(1000),
  
  -- –û–°–ù–û–í–ù–´–ï –ê–¢–†–ò–ë–£–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
  display_name        VARCHAR2(500),  -- name (–§–ò–û)
  description_field   VARCHAR2(1000), -- description (–æ—Ç–¥–µ–ª)  
  email_address       VARCHAR2(256),  -- mail (–ø–æ—á—Ç–∞)
  phone_number        VARCHAR2(50),   -- ipPhone (–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
  city_location       VARCHAR2(100),  -- l (–≥–æ—Ä–æ–¥)
  employee_id         VARCHAR2(50),   -- employeeID (id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
  department_name     VARCHAR2(500),  -- department (–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç)
  department_code     VARCHAR2(50),   -- PSKBKodDivision (–∫–æ–¥ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞)
  street_address      VARCHAR2(500),  -- streetAddress (—É–ª–∏—Ü–∞)
  job_title           VARCHAR2(256),  -- title (–¥–æ–ª–∂–Ω–æ—Å—Ç—å)
  company_name        VARCHAR2(256),  -- company (–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è)
  manager_dn          VARCHAR2(1000), -- manager (DN –º–µ–Ω–µ–¥–∂–µ—Ä–∞)
  manager_name        VARCHAR2(500),  -- —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
  user_principal_name VARCHAR2(256),  -- userPrincipalName
  telephone_number    VARCHAR2(50),   -- telephoneNumber
  mobile_number       VARCHAR2(50),   -- mobile
  office_location     VARCHAR2(256),  -- physicalDeliveryOfficeName
  when_created        DATE,           -- whenCreated
  account_control     NUMBER,         -- userAccountControl
  sync_status         VARCHAR2(10) DEFAULT 'ACTIVE',
  created_date        DATE DEFAULT SYSDATE,
  created_by          VARCHAR2(100) DEFAULT USER,
  modified_date       DATE,
  modified_by         VARCHAR2(100),
  last_sync_date      DATE,
  
  -- –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø
  CONSTRAINT chk_user_sync_status CHECK (sync_status IN ('ACTIVE', 'INACTIVE'))
);

-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (—Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å)
CREATE TABLE ad_user_extended_attributes (
  attribute_id       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id            VARCHAR2(100) NOT NULL,
  attribute_name     VARCHAR2(256) NOT NULL,
  attribute_value    CLOB,
  created_date       DATE DEFAULT SYSDATE,
  sync_session_id    VARCHAR2(50),
  CONSTRAINT fk_ext_attr_user FOREIGN KEY (user_id) REFERENCES ad_users(user_id),
  CONSTRAINT uk_user_attr_name UNIQUE (user_id, attribute_name)
);

-- –¢–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
CREATE TABLE ad_sync_log (
  log_id              NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  sync_session_id     VARCHAR2(50) NOT NULL,
  sync_type           VARCHAR2(50),
  sync_operation      VARCHAR2(100),
  object_identifier   VARCHAR2(500),
  sync_status         VARCHAR2(10),
  start_time          TIMESTAMP,
  end_time            TIMESTAMP,
  duration_seconds    NUMBER,
  records_processed   NUMBER DEFAULT 0,
  records_success     NUMBER DEFAULT 0,
  records_error       NUMBER DEFAULT 0,
  error_message       VARCHAR2(4000),
  detailed_log        CLOB,
  created_date        DATE DEFAULT SYSDATE,
  created_by          VARCHAR2(100) DEFAULT USER
);

-- –ò–ù–î–ï–ö–°–´ –î–õ–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò
CREATE INDEX idx_users_sam_account ON ad_users(sam_account_name);
CREATE INDEX idx_users_email ON ad_users(email_address);
CREATE INDEX idx_users_employee_id ON ad_users(employee_id);
CREATE INDEX idx_users_dept_code ON ad_users(department_code);
CREATE INDEX idx_users_sync_status ON ad_users(sync_status);
CREATE INDEX idx_users_last_sync ON ad_users(last_sync_date);

CREATE INDEX idx_ext_attr_user_id ON ad_user_extended_attributes(user_id);
CREATE INDEX idx_ext_attr_name ON ad_user_extended_attributes(attribute_name);

CREATE INDEX idx_sync_log_session ON ad_sync_log(sync_session_id);
CREATE INDEX idx_sync_log_type ON ad_sync_log(sync_type);
CREATE INDEX idx_sync_log_date ON ad_sync_log(created_date);

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
SELECT table_name, created FROM user_tables 
WHERE table_name IN ('AD_USERS', 'AD_USER_EXTENDED_ATTRIBUTES', 'AD_SYNC_LOG')
ORDER BY table_name;
```

---

#
CREATE OR REPLACE PACKAGE AD_SYNC_SERVICE.PKG_AD_SYNC AS

  -- –ö–û–ù–°–¢–ê–ù–¢–´
  C_SUCCESS   CONSTANT VARCHAR2(10) := 'SUCCESS';
  C_ERROR     CONSTANT VARCHAR2(10) := 'ERROR';
  C_WARNING   CONSTANT VARCHAR2(10) := 'WARNING';
  C_ACTIVE    CONSTANT VARCHAR2(10) := 'ACTIVE';
  C_INACTIVE  CONSTANT VARCHAR2(10) := 'INACTIVE';

  -- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø 
  TYPE t_config_rec IS RECORD (
    ldap_host         VARCHAR2(256),
    ldap_port         NUMBER,
    user_base_dn      VARCHAR2(512),
    bind_dn           VARCHAR2(512),
    bind_password     VARCHAR2(256),
    batch_size        NUMBER,
    user_filter       VARCHAR2(512),
    timeout_seconds   NUMBER,
    max_retries       NUMBER
  );

  -- –ú–ê–°–°–ò–í –ê–¢–†–ò–ë–£–¢–û–í
  TYPE t_required_attrs IS TABLE OF VARCHAR2(256) INDEX BY PLS_INTEGER;

  -- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò
  FUNCTION get_config RETURN t_config_rec;
  FUNCTION generate_session_id RETURN VARCHAR2;
  FUNCTION get_required_user_attributes RETURN t_required_attrs;
  
  FUNCTION get_ldap_attribute_value(
    p_session IN DBMS_LDAP.SESSION,
    p_entry IN DBMS_LDAP.MESSAGE,
    p_attribute_name IN VARCHAR2
  ) RETURN VARCHAR2;

  -- –§–£–ù–ö–¶–ò–ò –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø
  PROCEDURE show_user_attributes(p_sam_account VARCHAR2 DEFAULT NULL);
  PROCEDURE test_ldap_connection;

  -- –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
  PROCEDURE log_sync_event(
    p_session_id    IN VARCHAR2,
    p_sync_type     IN VARCHAR2,
    p_operation     IN VARCHAR2,
    p_object_id     IN VARCHAR2,
    p_status        IN VARCHAR2,
    p_start_time    IN TIMESTAMP,
    p_end_time      IN TIMESTAMP DEFAULT SYSTIMESTAMP,
    p_records_proc  IN NUMBER DEFAULT 0,
    p_records_succ  IN NUMBER DEFAULT 0,
    p_records_err   IN NUMBER DEFAULT 0,
    p_error_msg     IN VARCHAR2 DEFAULT NULL,
    p_detailed_log  IN CLOB DEFAULT NULL
  );

  -- –û–°–ù–û–í–ù–ê–Ø –ü–†–û–¶–ï–î–£–†–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò
  PROCEDURE sync_users_only;

END PKG_AD_SYNC;
/

-- ============================================================================
-- –¢–ï–õ–û –ü–ê–ö–ï–¢–ê
-- ============================================================================

CREATE OR REPLACE PACKAGE BODY AD_SYNC_SERVICE.PKG_AD_SYNC AS

  -- –°–û–ë–°–¢–í–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–î–ï–†–ñ–ö–ò (–í–ú–ï–°–¢–û DBMS_LOCK.SLEEP)
  PROCEDURE custom_sleep(p_seconds IN NUMBER) IS
    l_start_time DATE;
    l_current_time DATE;
    l_dummy NUMBER;
  BEGIN
    l_start_time := SYSDATE;
    LOOP
      SELECT 1 INTO l_dummy FROM dual WHERE ROWNUM = 1;
      l_current_time := SYSDATE;
      EXIT WHEN (l_current_time - l_start_time) * 24 * 3600 >= p_seconds;
    END LOOP;
  END custom_sleep;

  
  FUNCTION get_required_user_attributes RETURN t_required_attrs IS
    l_attrs t_required_attrs;
  BEGIN
   
    l_attrs(1)  := 'sAMAccountName';      
    l_attrs(2)  := 'name';                
    l_attrs(3)  := 'description';         
    l_attrs(4)  := 'mail';                
    l_attrs(5)  := 'ipPhone';             
    l_attrs(6)  := 'l';                   
    l_attrs(7)  := 'employeeID';          
    l_attrs(8)  := 'department';          
    l_attrs(9)  := 'PSKBKodDivision';     
    l_attrs(10) := 'streetAddress';       
    l_attrs(11) := 'title';              
    l_attrs(12) := 'company';             
    l_attrs(13) := 'manager';            
    
    
    l_attrs(14) := 'displayName';
    l_attrs(15) := 'distinguishedName';
    l_attrs(16) := 'userPrincipalName';
    l_attrs(17) := 'telephoneNumber';
    l_attrs(18) := 'mobile';
    l_attrs(19) := 'physicalDeliveryOfficeName';
    l_attrs(20) := 'whenCreated';
    l_attrs(21) := 'userAccountControl';
    l_attrs(22) := 'memberOf';
    l_attrs(23) := 'cn';
    l_attrs(24) := 'givenName';
    l_attrs(25) := 'sn';
    
    -- –ú–ï–°–¢–û –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ù–û–í–´–• –ê–¢–†–ò–ë–£–¢–û–í:
    -- l_attrs(26) := '–Ω–æ–≤—ã–π_–∞—Ç—Ä–∏–±—É—Ç';
    
    RETURN l_attrs;
  END get_required_user_attributes;

  -- –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –ò–ú–ï–ù–ò –ò–ó DN
  FUNCTION extract_name_from_dn(p_dn VARCHAR2) RETURN VARCHAR2 IS
    l_start_pos NUMBER;
    l_end_pos   NUMBER;
    l_result    VARCHAR2(256);
  BEGIN
    IF p_dn IS NULL THEN
      RETURN 'UNKNOWN';
    END IF;
    
    l_start_pos := INSTR(UPPER(p_dn), 'CN=');
    IF l_start_pos > 0 THEN
      l_start_pos := l_start_pos + 3;
      l_end_pos := INSTR(p_dn, ',', l_start_pos);
      IF l_end_pos = 0 THEN
        l_end_pos := LENGTH(p_dn) + 1;
      END IF;
      l_result := TRIM(SUBSTR(p_dn, l_start_pos, l_end_pos - l_start_pos));
    ELSE
      l_result := 'USER_' || TO_CHAR(SYSDATE, 'HH24MISS');
    END IF;
    
    RETURN l_result;
  END extract_name_from_dn;

  -- –ü–û–õ–£–ß–ï–ù–ò–ï –ó–ù–ê–ß–ï–ù–ò–Ø
  FUNCTION get_ldap_attribute_value(
    p_session IN DBMS_LDAP.SESSION,
    p_entry IN DBMS_LDAP.MESSAGE,
    p_attribute_name IN VARCHAR2
  ) RETURN VARCHAR2 IS
    l_values      DBMS_LDAP.STRING_COLLECTION;
    l_value_count NUMBER;
  BEGIN
    l_values := DBMS_LDAP.get_values(
      ld => p_session,
      ldapentry => p_entry,
      attr => p_attribute_name
    );
    
    l_value_count := DBMS_LDAP.count_values(l_values);
    IF l_value_count > 0 THEN
      RETURN l_values(l_values.FIRST);
    ELSE
      RETURN NULL;
    END IF;
    
  EXCEPTION
    WHEN OTHERS THEN
      RETURN NULL;
  END get_ldap_attribute_value;

  -- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ù–ê–°–¢–†–û–ò–¢–¨ –ü–û–î –°–í–û–ò –ü–ê–†–ê–ú–ï–¢–†–´!)
  FUNCTION get_config RETURN t_config_rec IS
    l_config t_config_rec;
  BEGIN
    CONF
    
   
    l_config.batch_size := 50;  -- –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    l_config.user_filter := '(&(objectClass=person)(sAMAccountName=*)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))';
    l_config.timeout_seconds := 300;
    l_config.max_retries := 3;

    RETURN l_config;
  END get_config;

  -- –ì–ï–ù–ï–†–ê–¶–ò–Ø ID –°–ï–°–°–ò–ò
  FUNCTION generate_session_id RETURN VARCHAR2 IS
  BEGIN
    RETURN 'SYNC_' || TO_CHAR(SYSDATE, 'YYYYMMDD_HH24MISS') || '_' || 
           LPAD(TRUNC(DBMS_RANDOM.VALUE(1000, 9999)), 4, '0');
  END generate_session_id;

  -- –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –°–û–ë–´–¢–ò–ô
  PROCEDURE log_sync_event(
    p_session_id    IN VARCHAR2,
    p_sync_type     IN VARCHAR2,
    p_operation     IN VARCHAR2,
    p_object_id     IN VARCHAR2,
    p_status        IN VARCHAR2,
    p_start_time    IN TIMESTAMP,
    p_end_time      IN TIMESTAMP DEFAULT SYSTIMESTAMP,
    p_records_proc  IN NUMBER DEFAULT 0,
    p_records_succ  IN NUMBER DEFAULT 0,
    p_records_err   IN NUMBER DEFAULT 0,
    p_error_msg     IN VARCHAR2 DEFAULT NULL,
    p_detailed_log  IN CLOB DEFAULT NULL
  ) IS
    PRAGMA AUTONOMOUS_TRANSACTION;
  BEGIN
    INSERT INTO ad_sync_log (
      sync_session_id, sync_type, sync_operation, object_identifier, sync_status,
      start_time, end_time, duration_seconds, records_processed, records_success, 
      records_error, error_message, detailed_log, created_date, created_by
    ) VALUES (
      p_session_id, p_sync_type, p_operation, p_object_id, p_status,
      p_start_time, p_end_time, 
      CASE WHEN p_end_time > p_start_time 
           THEN EXTRACT(SECOND FROM (p_end_time - p_start_time))
           ELSE 0 END,
      p_records_proc, p_records_succ, p_records_err, 
      SUBSTR(p_error_msg, 1, 4000), p_detailed_log, SYSDATE, USER
    );
    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN NULL;
  END log_sync_event;

  -- –¢–ï–°–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö LDAP
  PROCEDURE test_ldap_connection IS
    l_config  t_config_rec;
    l_session DBMS_LDAP.SESSION;
    l_retval  PLS_INTEGER;
  BEGIN
    l_config := get_config();
    
    DBMS_OUTPUT.ENABLE(1000000);
    DBMS_OUTPUT.PUT_LINE('=== –¢–ï–°–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ===');
    DBMS_OUTPUT.PUT_LINE('–°–µ—Ä–≤–µ—Ä: ' || l_config.ldap_host || ':' || l_config.ldap_port);
    
    BEGIN
      l_session := DBMS_LDAP.init(l_config.ldap_host, l_config.ldap_port);
      DBMS_OUTPUT.PUT_LINE('‚úì –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
      
      l_retval := DBMS_LDAP.simple_bind_s(l_session, l_config.bind_dn, l_config.bind_password);
      
      IF l_retval = DBMS_LDAP.SUCCESS THEN
        DBMS_OUTPUT.PUT_LINE('‚úì –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
      ELSE
        DBMS_OUTPUT.PUT_LINE('‚úó –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ' || l_retval);
      END IF;
      
      l_retval := DBMS_LDAP.unbind_s(l_session);
      
    EXCEPTION
      WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('‚úó –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' || SQLERRM);
    END;
    
    DBMS_OUTPUT.PUT_LINE('===============================');
  END test_ldap_connection;

  -- –ü–û–ö–ê–ó–ê–¢–¨ –ê–¢–†–ò–ë–£–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–î–õ–Ø –û–¢–õ–ê–î–ö–ò)
  PROCEDURE show_user_attributes(p_sam_account VARCHAR2 DEFAULT NULL) IS
    l_config      t_config_rec;
    l_session     DBMS_LDAP.SESSION;
    l_retval      PLS_INTEGER;
    l_message     DBMS_LDAP.MESSAGE;
    l_entry       DBMS_LDAP.MESSAGE;
    l_dn          VARCHAR2(2000);
    l_attrs       DBMS_LDAP.STRING_COLLECTION;
    l_attr_name   VARCHAR2(256);
    l_attr_value  VARCHAR2(4000);
    l_ber_element DBMS_LDAP.BER_ELEMENT;
    l_filter      VARCHAR2(256);
    l_count       NUMBER := 0;
  BEGIN
    l_config := get_config();
    
    IF p_sam_account IS NOT NULL THEN
      l_filter := '(&(objectClass=person)(sAMAccountName=' || p_sam_account || '))';
    ELSE
      l_filter := '(&(objectClass=person)(sAMAccountName=*))';
    END IF;
    
    DBMS_OUTPUT.ENABLE(1000000);
    DBMS_OUTPUT.PUT_LINE('=== –ê–¢–†–ò–ë–£–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===');
    
    l_session := DBMS_LDAP.init(l_config.ldap_host, l_config.ldap_port);
    l_retval := DBMS_LDAP.simple_bind_s(l_session, l_config.bind_dn, l_config.bind_password);
    
    IF l_retval = DBMS_LDAP.SUCCESS THEN
      l_retval := DBMS_LDAP.search_s(
        ld => l_session,
        base => l_config.user_base_dn,
        scope => DBMS_LDAP.SCOPE_SUBTREE,
        filter => l_filter,
        attrs => l_attrs,
        attronly => 0,
        res => l_message
      );
      
      IF l_retval = DBMS_LDAP.SUCCESS THEN
        l_entry := DBMS_LDAP.first_entry(l_session, l_message);
        
        IF l_entry IS NOT NULL THEN
          l_dn := DBMS_LDAP.get_dn(l_session, l_entry);
          DBMS_OUTPUT.PUT_LINE('DN: ' || l_dn);
          DBMS_OUTPUT.PUT_LINE('==============================');
          
          l_attr_name := DBMS_LDAP.first_attribute(l_session, l_entry, l_ber_element);
          
          WHILE l_attr_name IS NOT NULL LOOP
            l_attr_value := get_ldap_attribute_value(l_session, l_entry, l_attr_name);
            l_count := l_count + 1;
            
            DBMS_OUTPUT.PUT_LINE(l_count || '. ' || l_attr_name || ' = ' || 
                               SUBSTR(NVL(l_attr_value, '<–ø—É—Å—Ç–æ>'), 1, 100));
            
            l_attr_name := DBMS_LDAP.next_attribute(l_session, l_entry, l_ber_element);
          END LOOP;
        END IF;
      END IF;
    END IF;
    
    l_retval := DBMS_LDAP.unbind_s(l_session);
    DBMS_OUTPUT.PUT_LINE('==============================');
    
  EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('–û–®–ò–ë–ö–ê: ' || SQLERRM);
      IF l_session IS NOT NULL THEN
        l_retval := DBMS_LDAP.unbind_s(l_session);
      END IF;
  END show_user_attributes;

  -- –û–°–ù–û–í–ù–ê–Ø –ü–†–û–¶–ï–î–£–†–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò 
  PROCEDURE sync_users_only IS
    l_config        t_config_rec;
    l_session_id    VARCHAR2(50);
    l_start_time    TIMESTAMP;
    l_session       DBMS_LDAP.SESSION;
    l_retval        PLS_INTEGER;
    l_message       DBMS_LDAP.MESSAGE;
    l_entry         DBMS_LDAP.MESSAGE;
    l_dn            VARCHAR2(2000);
    l_sam_account   VARCHAR2(256);
    l_processed     NUMBER := 0;
    l_success       NUMBER := 0;
    l_errors        NUMBER := 0;
    l_retry_count   NUMBER := 0;
    l_attrs         DBMS_LDAP.STRING_COLLECTION;
    l_user_id       VARCHAR2(100);
    
    -- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –í–°–ï–• –ê–¢–†–ò–ë–£–¢–û–í –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    l_display_name      VARCHAR2(500);
    l_description       VARCHAR2(1000);
    l_email             VARCHAR2(256);
    l_ip_phone          VARCHAR2(50);
    l_city              VARCHAR2(100);
    l_employee_id       VARCHAR2(50);
    l_department        VARCHAR2(500);
    l_dept_code         VARCHAR2(50);
    l_street_address    VARCHAR2(500);
    l_job_title         VARCHAR2(256);
    l_company           VARCHAR2(256);
    l_manager_dn        VARCHAR2(1000);
    l_manager_name      VARCHAR2(500);
    
  BEGIN
    l_config := get_config();
    l_session_id := generate_session_id();
    l_start_time := SYSTIMESTAMP;

    log_sync_event(l_session_id, 'USERS', 'SYNC_START', 'BULK', 
                   C_SUCCESS, l_start_time);

    -- –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö
    UPDATE ad_users 
    SET sync_status = C_INACTIVE, last_sync_date = SYSDATE;

    -- –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ –° –ü–û–í–¢–û–†–ù–´–ú–ò –ü–û–ü–´–¢–ö–ê–ú–ò
    WHILE l_retry_count < l_config.max_retries LOOP
      BEGIN
        -- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ LDAP
        l_session := DBMS_LDAP.init(l_config.ldap_host, l_config.ldap_port);
        l_retval := DBMS_LDAP.simple_bind_s(l_session, l_config.bind_dn, l_config.bind_password);
        
        IF l_retval = DBMS_LDAP.SUCCESS THEN
          -- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          l_retval := DBMS_LDAP.search_s(
            ld => l_session,
            base => l_config.user_base_dn,
            scope => DBMS_LDAP.SCOPE_SUBTREE,
            filter => l_config.user_filter,
            attrs => l_attrs,  -- –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã
            attronly => 0,
            res => l_message
          );
          
          IF l_retval = DBMS_LDAP.SUCCESS THEN
            l_entry := DBMS_LDAP.first_entry(l_session, l_message);
            
            -- –û–ë–†–ê–ë–ê–¢–´–í–ê–ï–ú –ö–ê–ñ–î–û–ì–û 
            WHILE l_entry IS NOT NULL LOOP
              BEGIN
                l_dn := DBMS_LDAP.get_dn(l_session, l_entry);
                l_sam_account := get_ldap_attribute_value(l_session, l_entry, 'sAMAccountName');
                
                IF l_sam_account IS NOT NULL THEN
                  l_user_id := 'U' || TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') || '_' || l_processed;
                  
                  -- –ü–û–õ–£–ß–ê–ï–ú –í–°–ï –ù–£–ñ–ù–´–ï –ê–¢–†–ò–ë–£–¢–´
                  l_display_name := get_ldap_attribute_value(l_session, l_entry, 'name');
                  l_description := get_ldap_attribute_value(l_session, l_entry, 'description');
                  l_email := get_ldap_attribute_value(l_session, l_entry, 'mail');
                  l_ip_phone := get_ldap_attribute_value(l_session, l_entry, 'ipPhone');
                  l_city := get_ldap_attribute_value(l_session, l_entry, 'l');
                  l_employee_id := get_ldap_attribute_value(l_session, l_entry, 'employeeID');
                  l_department := get_ldap_attribute_value(l_session, l_entry, 'department');
                  l_dept_code := get_ldap_attribute_value(l_session, l_entry, 'PSKBKodDivision');
                  l_street_address := get_ldap_attribute_value(l_session, l_entry, 'streetAddress');
                  l_job_title := get_ldap_attribute_value(l_session, l_entry, 'title');
                  l_company := get_ldap_attribute_value(l_session, l_entry, 'company');
                  l_manager_dn := get_ldap_attribute_value(l_session, l_entry, 'manager');
                  l_manager_name := extract_name_from_dn(l_manager_dn);
                  
                  -- –°–û–•–†–ê–ù–Ø–ï–ú –ë–ê–ó–ï
                  MERGE INTO ad_users tgt
                  USING (
                    SELECT l_sam_account as sam_account_name, l_dn as distinguished_name
                    FROM dual
                  ) src ON (tgt.sam_account_name = src.sam_account_name)
                  WHEN MATCHED THEN UPDATE SET
                    distinguished_name = src.distinguished_name,
                    display_name = l_display_name,
                    description_field = l_description,
                    email_address = l_email,
                    phone_number = l_ip_phone,
                    city_location = l_city,
                    employee_id = l_employee_id,
                    department_name = l_department,
                    department_code = l_dept_code,
                    street_address = l_street_address,
                    job_title = l_job_title,
                    company_name = l_company,
                    manager_dn = l_manager_dn,
                    manager_name = l_manager_name,
                    sync_status = C_ACTIVE,
                    last_sync_date = SYSDATE,
                    modified_by = USER,
                    modified_date = SYSDATE
                  WHEN NOT MATCHED THEN INSERT (
                    user_id, sam_account_name, distinguished_name,
                    display_name, description_field, email_address, phone_number,
                    city_location, employee_id, department_name, department_code,
                    street_address, job_title, company_name, manager_dn, manager_name,
                    sync_status, created_date, created_by, last_sync_date
                  ) VALUES (
                    l_user_id, src.sam_account_name, src.distinguished_name,
                    l_display_name, l_description, l_email, l_ip_phone,
                    l_city, l_employee_id, l_department, l_dept_code,
                    l_street_address, l_job_title, l_company, l_manager_dn, l_manager_name,
                    C_ACTIVE, SYSDATE, USER, SYSDATE
                  );
                  
                  l_success := l_success + 1;
                  
                  -- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–º–º–∏—Ç—ã –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è Internal Server Error
                  IF MOD(l_success, l_config.batch_size) = 0 THEN
                    COMMIT;
                  END IF;
                END IF;
                
              EXCEPTION
                WHEN OTHERS THEN
                  l_errors := l_errors + 1;
                  log_sync_event(l_session_id, 'USERS', 'USER_ERROR', 
                                l_sam_account, C_ERROR, l_start_time, 
                                p_error_msg => SQLERRM);
              END;
              
              l_processed := l_processed + 1;
              l_entry := DBMS_LDAP.next_entry(l_session, l_entry);
            END LOOP;
            
            EXIT; -- –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏
          END IF;
        END IF;
        
        -- –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        l_retval := DBMS_LDAP.unbind_s(l_session);
        
      EXCEPTION
        WHEN OTHERS THEN
          l_retry_count := l_retry_count + 1;
          
          -- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
          IF l_session IS NOT NULL THEN
            BEGIN
              l_retval := DBMS_LDAP.unbind_s(l_session);
            EXCEPTION WHEN OTHERS THEN NULL;
            END;
          END IF;
          
          -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤
          IF l_retry_count >= l_config.max_retries THEN
            log_sync_event(l_session_id, 'USERS', 'LDAP_FINAL_ERROR', 
                          'CONNECTION', C_ERROR, l_start_time, p_error_msg => SQLERRM);
            RAISE;
          ELSE
            log_sync_event(l_session_id, 'USERS', 'RETRY_' || l_retry_count,
                          'CONNECTION', C_WARNING, l_start_time, p_error_msg => SQLERRM);
            custom_sleep(2); -- –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º
          END IF;
      END;
    END LOOP;

    COMMIT;
    
    
    DELETE FROM ad_users WHERE sync_status = C_INACTIVE;
    COMMIT;

    -- –§–∏–Ω–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    log_sync_event(l_session_id, 'USERS', 'SYNC_COMPLETE', 'BULK',
                   CASE WHEN l_errors = 0 THEN C_SUCCESS ELSE C_WARNING END,
                   l_start_time, p_records_proc => l_processed,
                   p_records_succ => l_success, p_records_err => l_errors);

  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      log_sync_event(l_session_id, 'USERS', 'SYNC_FAILED', 'BULK',
                     C_ERROR, l_start_time, p_error_msg => SQLERRM);
      RAISE;
  END sync_users_only;

END PKG_AD_SYNC;
/
```

-- ============================================================================
-- –£–î–û–ë–ù–´–ï –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –†–ê–ë–û–¢–´ –° –î–ê–ù–ù–´–ú–ò
-- ============================================================================

-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
CREATE OR REPLACE VIEW v_ad_users AS
SELECT 
  user_id,
  sam_account_name as login,
  display_name as full_name,
  email_address as email,
  phone_number as phone,
  job_title as position,
  department_name as department,
  department_code as dept_code,
  manager_name as manager,
  city_location as city,
  company_name as company,
  employee_id as emp_id,
  street_address as address,
  TO_CHAR(last_sync_date, 'DD.MM.YYYY HH24:MI') as last_sync,
  sync_status
FROM ad_users
WHERE sync_status = 'ACTIVE'
ORDER BY display_name;

-- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE OR REPLACE VIEW v_user_search AS
SELECT 
  sam_account_name as login,
  display_name as name,
  email_address as email,
  department_name as dept,
  job_title as position,
  phone_number as phone
FROM ad_users
WHERE sync_status = 'ACTIVE';
```

---





SELECT object_name, object_type, status,
       TO_CHAR(last_ddl_time, 'DD.MM.YYYY HH24:MI:SS') as compiled_time
FROM user_objects 
WHERE object_name = 'PKG_AD_SYNC'
ORDER BY object_type;

-- –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å STATUS = 'VALID'
```

### 4.3 
BEGIN
  AD_SYNC_SERVICE.PKG_AD_SYNC.test_ldap_connection;
END;
/

-- 
```sql
-- –°–º–æ—Ç—Ä–∏–º –∞—Ç—Ä–∏–±—É—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
BEGIN
  AD_SYNC_SERVICE.PKG_AD_SYNC.show_user_attributes;
END;
/

-- –°–º–æ—Ç—Ä–∏–º –∞—Ç—Ä–∏–±—É—Ç—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
BEGIN
  AD_SYNC_SERVICE.PKG_AD_SYNC.show_user_attributes('–ª–æ–≥–∏–Ω.–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
END;
/
```

### 5.1 –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

```sql
-- –ó–∞–ø—É—Å–∫ 
BEGIN
  DBMS_OUTPUT.ENABLE(1000000);
  DBMS_OUTPUT.PUT_LINE('=== –ó–ê–ü–£–°–ö –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò  ===');
  
  AD_SYNC_SERVICE.PKG_AD_SYNC.sync_users_only;
  
  DBMS_OUTPUT.PUT_LINE('=== –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê ===');
END;
/
```

### 5.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö 
SELECT COUNT(*) as total_users, 
       COUNT(CASE WHEN sync_status = 'ACTIVE' THEN 1 END) as active_users
FROM ad_users;

-- –°–º–æ—Ç—Ä–∏–º –ø–µ—Ä–≤—ã—Ö
SELECT login, full_name, email, phone, position, department
FROM v_ad_users
WHERE ROWNUM <= 10;

-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
SELECT sync_operation, sync_status, records_success, records_error,
       TO_CHAR(created_date, 'DD.MM.YYYY HH24:MI:SS') as sync_time,
       SUBSTR(error_message, 1, 100) as error_preview
FROM ad_sync_log
ORDER BY created_date DESC
FETCH FIRST 5 ROWS ONLY;
```

---

## üîß –£–°–¢–†–ê–ù–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú

### –ü—Ä–æ–±–ª–µ–º–∞: Internal Server Error
```sql
-- –£–º–µ–Ω—å—à–∏—Ç–µ batch_size –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
-- l_config.batch_size := 20;  -- –≤–º–µ—Å—Ç–æ 50
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ –Ω–∞—Ö–æ–¥–∏—Ç 
```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä –∏ base DN:
BEGIN
  AD_SYNC_SERVICE.PKG_AD_SYNC.show_user_attributes;
END;
/
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ 
```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ credentials:
BEGIN
  AD_SYNC_SERVICE.PKG_AD_SYNC.test_ldap_connection;
END;
/
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
```sql
-- –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞–∫–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã —Ä–µ–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã:
BEGIN
  AD_SYNC_SERVICE.PKG_AD_SYNC.show_user_attributes('—Ç–µ—Å—Ç–æ–≤—ã–π.–ª–æ–≥–∏–Ω');
END;
/
```

---

## üìã 

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫:
```sql
BEGIN
  AD_SYNC_SERVICE.PKG_AD_SYNC.sync_users_only;
END;
/
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ (—á–µ—Ä–µ–∑ DBMS_SCHEDULER):
```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ –¥–∂–æ–±–∞ –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ 6:00
BEGIN
  DBMS_SCHEDULER.create_job (
    job_name        => 'AD_SYNC_DAILY',
    job_type        => 'PLSQL_BLOCK',
    job_action      => 'BEGIN AD_SYNC_SERVICE.PKG_AD_SYNC.sync_users_only; END;',
    start_date      => SYSTIMESTAMP,
    repeat_interval => 'FREQ=DAILY; BYHOUR=6; BYMINUTE=0; BYSECOND=0',
    enabled         => TRUE
  );
END;
/
```

---


1. **–î–æ–±–∞–≤—å—Ç–µ –≤ —Ñ—É–Ω–∫—Ü–∏—é `get_required_user_attributes()`:**
   ```sql
   l_attrs(26) := '–Ω–æ–≤—ã–π_–∞—Ç—Ä–∏–±—É—Ç';
   ```

2. **–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞, –¥–æ–±–∞–≤—å—Ç–µ –≤ —Ç–∞–±–ª–∏—Ü—É:**
   ```sql
   ALTER TABLE ad_users ADD new_field VARCHAR2(256);
   ```

3. **–û–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É `sync_users_only`:**
   ```sql
   l_new_field := get_ldap_attribute_value(l_session, l_entry, '–Ω–æ–≤—ã–π_–∞—Ç—Ä–∏–±—É—Ç');
   -- –ò –¥–æ–±–∞–≤—å—Ç–µ –≤ MERGE –æ–ø–µ—Ä–∞—Ü–∏—é
   ```

---



```sql
-- –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã:
SELECT 'Users synced: ' || COUNT(*) as status FROM ad_users WHERE sync_status = 'ACTIVE'
UNION ALL
SELECT 'Last sync: ' || TO_CHAR(MAX(last_sync_date), 'DD.MM.YYYY HH24:MI:SS') FROM ad_users
UNION ALL  
SELECT 'Package status: ' || status FROM user_objects WHERE object_name = 'PKG_AD_SYNC' AND object_type = 'PACKAGE BODY';
```

--
