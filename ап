Для ведения журнала изменений в Oracle APEX можно использовать триггер на уровне строки в PL/SQL, который будет записывать старые значения (:OLD) в отдельную таблицу журнала.

1. Создание таблицы журнала

Создадим таблицу, куда будем записывать старые значения перед изменением или удалением:

create table audit_log (
    id           number generated always as identity primary key,
    table_name   varchar2(100),
    operation    varchar2(10),
    changed_by   varchar2(100),
    changed_at   timestamp default systimestamp,
    old_data     clob
);

table_name – имя таблицы, в которой произошло изменение.

operation – UPDATE или DELETE.

changed_by – пользователь, совершивший изменение (v('APP_USER') в APEX).

changed_at – время изменения.

old_data – JSON-структура со старыми значениями.


2. Создание триггера для отслеживания изменений

Допустим, у вас есть таблица employees, и вы хотите вести журнал её изменений.

create or replace trigger trg_employees_audit
before update or delete on employees
for each row
declare
    v_old_data clob;
begin
    -- Преобразуем старые значения в JSON
    v_old_data := json_object(
        'employee_id' value :OLD.employee_id,
        'name' value :OLD.name,
        'position' value :OLD.position,
        'salary' value :OLD.salary
    ) returning clob;

    -- Вставляем запись в журнал
    insert into audit_log (table_name, operation, changed_by, old_data)
    values ('EMPLOYEES', case when deleting then 'DELETE' else 'UPDATE' end, v('APP_USER'), v_old_data);
end;
/

3. Просмотр журнала изменений

Вы можете просматривать журнал так:

select * from audit_log order by changed_at desc;

Дополнительно

1. Если у вас много колонок, можно использовать json_object(*) вместо явного перечисления полей:

v_old_data := json_object(*) returning clob;


2. Если требуется журналировать вставки, добавьте INSERT в триггере и используйте :NEW для новых данных.


3. Можно создать глобальную процедуру для ведения журнала и использовать её во всех таблицах.



Такой подход обеспечит прозрачность и позволит отслеживать изменения в данных.

