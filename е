WITH a AS (
  SELECT 
    id, title, div_name, descr, status_current,
    xml_data,
    sprint_num,
    priority,
    business_rus
  FROM (
    SELECT 
      t.*,
      x.sprint_num,
      x.priority, 
      x.business_rus
    FROM PST_ESUZ_CURATORS t
    CROSS APPLY XMLTABLE(
      '//sirow'
      PASSING t.all_data
      COLUMNS
        sprint_num VARCHAR2(100) PATH 'Бизнес_приоритет',
        priority VARCHAR2(100) PATH 'Бизнес_x0420_x0443_x0441_x0440_x04',
        business_rus VARCHAR2(100) PATH 'Бизнес_x0440_x0443_x0441'
    ) x
    WHERE x.sprint_num IS NOT NULL
      AND REGEXP_REPLACE(x.sprint_num, '[^0-9]', '') IN (
        SELECT REGEXP_SUBSTR(:P24_SPRINT, '[^:]+', 1, LEVEL) 
        FROM DUAL 
        CONNECT BY REGEXP_SUBSTR(:P24_SPRINT, '[^:]+', 1, LEVEL) IS NOT NULL
      )
  )
),
developers AS (
  SELECT 
    t.id,
    x.developer_name,
    i.end_date
  FROM PST_ESUZ_CURATORS t
  CROSS APPLY XMLTABLE(
    '//sirow'
    PASSING t.all_data
    COLUMNS
      developer_name VARCHAR2(255) PATH 'Бизнес_приоритет'
  ) x
  LEFT JOIN PST_ESUZ_ISSUES_TIMEWAY i ON i.id = t.id
  WHERE x.developer_name IS NOT NULL
)
SELECT 
  a.id,
  a.title,
  a.div_name,
  a.descr,
  a.status_current,
  a.sprint_num,
  a.priority,
  a.business_rus,
  d.developer_name,
  d.end_date
FROM a
LEFT JOIN developers d ON d.id = a.id
WHERE a.sprint_num IN (
  SELECT REGEXP_SUBSTR(:P24_SPRINT, '[^:]+', 1, LEVEL) 
  FROM DUAL 
  CONNECT BY REGEXP_SUBSTR(:P24_SPRINT, '[^:]+', 1, LEVEL) IS NOT NULL
)
ORDER BY a.id;
