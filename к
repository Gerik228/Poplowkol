
BEGIN
  FOR t IN (SELECT trigger_name FROM user_triggers WHERE trigger_name LIKE 'TRG_AUDIT_%') LOOP
    EXECUTE IMMEDIATE 'DROP TRIGGER '||t.trigger_name;
  END LOOP;
END;
/
BEGIN
  EXECUTE IMMEDIATE 'DROP PACKAGE audit_pkg';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE audit_log_details CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE audit_log CASCADE CONSTRAINTS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
  EXECUTE IMMEDIATE 'DROP VIEW v_audit_full';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
BEGIN
  EXECUTE IMMEDIATE 'DROP VIEW v_audit_summary';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/
```

## 2. Создайте новые таблицы аудита

```sql
CREATE TABLE audit_log (
  audit_id     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  table_name   VARCHAR2(128) NOT NULL,
  record_id    NUMBER NOT NULL,
  record_name  VARCHAR2(500),
  event_type   VARCHAR2(20) NOT NULL,
  event_date   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  user_name    VARCHAR2(100) DEFAULT NVL(
      SYS_CONTEXT('APEX$SESSION','APP_USER'),
      SYS_CONTEXT('USERENV','SESSION_USER')
  ),
  session_id   NUMBER DEFAULT SYS_CONTEXT('USERENV','SESSIONID'),
  created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
/

CREATE TABLE audit_log_details (
  detail_id   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  audit_id    NUMBER NOT NULL,
  column_name VARCHAR2(128) NOT NULL,
  old_value   CLOB,
  new_value   CLOB,
  data_type   VARCHAR2(50),
  change_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
/

ALTER TABLE audit_log_details
  ADD CONSTRAINT fk_audit_details_log
  FOREIGN KEY(audit_id) REFERENCES audit_log(audit_id);
/
```

## 3. Универсальный пакет для автоматических триггеров

### Спецификация

```sql
CREATE OR REPLACE PACKAGE audit_pkg AS
  PROCEDURE create_audit_trigger(
    p_table_name   IN VARCHAR2,
    p_pk_column    IN VARCHAR2,
    p_title_column IN VARCHAR2 DEFAULT NULL
  );
END audit_pkg;
/
```

### Тело пакета

```sql
CREATE OR REPLACE PACKAGE BODY audit_pkg AS

  PROCEDURE create_audit_trigger(
    p_table_name   IN VARCHAR2,
    p_pk_column    IN VARCHAR2,
    p_title_column IN VARCHAR2 DEFAULT NULL
  ) AS
    l_sql       CLOB;
    c_cols      SYS_REFCURSOR;
    l_col_name  VARCHAR2(128);
    l_data_type VARCHAR2(128);
  BEGIN
    OPEN c_cols FOR
      SELECT column_name, data_type
        FROM user_tab_columns
       WHERE table_name      = UPPER(p_table_name)
         AND column_name    <> UPPER(p_pk_column)
         AND identity_column = 'NO'
       ORDER BY column_id;

    l_sql := 'CREATE OR REPLACE TRIGGER TRG_AUDIT_' || UPPER(p_table_name) || '
    AFTER INSERT OR UPDATE OR DELETE ON ' || p_table_name || '
    FOR EACH ROW
    DECLARE
      v_audit_id   NUMBER;
      v_rec_id     NUMBER;
      v_rec_name   VARCHAR2(500);
      v_event_type VARCHAR2(20);
    BEGIN
      IF INSERTING THEN
        v_event_type := ''INSERT'';
        v_rec_id     := :NEW.' || p_pk_column || ';
        v_rec_name   := ' || CASE
                             WHEN p_title_column IS NOT NULL
                             THEN ':NEW.' || p_title_column
                             ELSE 'NULL' END || ';
      ELSIF UPDATING THEN
        v_event_type := ''UPDATE'';
        v_rec_id     := :NEW.' || p_pk_column || ';
        v_rec_name   := ' || CASE
                             WHEN p_title_column IS NOT NULL
                             THEN ':NEW.' || p_title_column
                             ELSE 'NULL' END || ';
      ELSIF DELETING THEN
        v_event_type := ''DELETE'';
        v_rec_id     := :OLD.' || p_pk_column || ';
        v_rec_name   := ' || CASE
                             WHEN p_title_column IS NOT NULL
                             THEN ':OLD.' || p_title_column
                             ELSE 'NULL' END || ';
      END IF;

      INSERT INTO audit_log(table_name, record_id, record_name, event_type)
      VALUES(
        ''' || UPPER(p_table_name) || ''',
        v_rec_id, v_rec_name, v_event_type
      ) RETURNING audit_id INTO v_audit_id;';

    LOOP
      FETCH c_cols INTO l_col_name, l_data_type;
      EXIT WHEN c_cols%NOTFOUND;
      l_sql := l_sql || '
      IF INSERTING THEN
        INSERT INTO audit_log_details(
          audit_id, column_name, old_value, new_value, data_type
        ) VALUES (
          v_audit_id, ''' || l_col_name || ''', NULL,
          TO_CLOB(:NEW.' || l_col_name || '), ''' || l_data_type || '''
        );
      ELSIF UPDATING THEN
        IF NVL(TO_CHAR(:OLD.' || l_col_name || '),''$$NULL$$'')
         <> NVL(TO_CHAR(:NEW.' || l_col_name || '),''$$NULL$$'') THEN
          INSERT INTO audit_log_details(
            audit_id, column_name, old_value, new_value, data_type
          ) VALUES (
            v_audit_id, ''' || l_col_name || ''',
            TO_CLOB(:OLD.' || l_col_name || '),
            TO_CLOB(:NEW.' || l_col_name || '),
            ''' || l_data_type || '''
          );
        END IF;
      ELSIF DELETING THEN
        INSERT INTO audit_log_details(
          audit_id, column_name, old_value, new_value, data_type
        ) VALUES (
          v_audit_id, ''' || l_col_name || ''',
          TO_CLOB(:OLD.' || l_col_name || '), NULL, ''' || l_data_type || '''
        );
      END IF;';
    END LOOP;
    CLOSE c_cols;

    l_sql := l_sql || '
    EXCEPTION WHEN OTHERS THEN NULL;
    END;';

    BEGIN
      EXECUTE IMMEDIATE 'DROP TRIGGER TRG_AUDIT_' || UPPER(p_table_name);
    EXCEPTION WHEN OTHERS THEN NULL;
    END;

    EXECUTE IMMEDIATE l_sql;
  END create_audit_trigger;

END audit_pkg;
/
```

## 4. Применение аудита к нужным таблицам

Запускайте PL/SQL-блок для каждой таблицы (пример для EMPLOYEES):

```sql
BEGIN
  audit_pkg.create_audit_trigger(
    p_table_name   => 'EMPLOYEES',
    p_pk_column    => 'EMPLOYEE_ID',    -- PK-столбец должен быть NUMBER!
    p_title_column => 'LAST_NAME'       -- по желанию: отображаемое имя
  );
END;
/
```

Для таблиц, где нет наименования:

```sql
BEGIN
  audit_pkg.create_audit_trigger(
    p_table_name   => 'ORDERS',
    p_pk_column    => 'ORDER_ID',
    p_title_column => NULL
  );
END;
/
```

## 5. Представления для удобного просмотра

```sql
CREATE OR REPLACE VIEW v_audit_full AS
SELECT
  al.audit_id,
  al.table_name,
  al.record_id,
  al.record_name,
  al.event_type,
  al.event_date,
  al.user_name   AS event_user,
  ald.detail_id,
  ald.column_name,
  ald.old_value,
  ald.new_value,
  ald.data_type,
  ald.change_date
FROM audit_log al
LEFT JOIN audit_log_details ald ON al.audit_id = ald.audit_id
ORDER BY al.event_date DESC, ald.detail_id;
/

CREATE OR REPLACE VIEW v_audit_summary AS
SELECT
  table_name,
  event_type,
  COUNT(*) AS event_count,
  MIN(event_date) AS first_event,
  MAX(event_date) AS last_event,
  COUNT(DISTINCT user_name) AS unique_users
FROM audit_log
GROUP BY table_name, event_type
ORDER BY table_name, event_type;
/
```

## 