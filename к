давай сделаем эточе через beacon .
напиши подробную инструкцию как нам сделать это логирование. .

## Детальная инструкция по реализации логирования кликов через Beacon API в Oracle APEX 23.1

### Введение

Beacon API — это современный веб-стандарт для отправки небольших объемов данных на сервер без ожидания ответа[1]. Особенность этого API в том, что он **гарантированно отправляет данные даже при закрытии страницы**[2], что делает его идеальным для логирования пользовательских действий.

### Преимущества Beacon API для логирования

- **Неблокирующий**: не замедляет переходы между страницами[3]
- **Гарантированная отправка**: данные отправляются даже при закрытии браузера[2]
- **Асинхронный**: не требует ожидания ответа от сервера[1]
- **Оптимизированный**: специально разработан для аналитики и логирования[4]

### Шаг 1: Создание таблицы для логов

Создайте таблицу в вашей базе данных для хранения логов кликов:

```sql
CREATE TABLE BEACON_CLICK_LOG (
    ID           NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME     VARCHAR2(255),
    CLICK_TIME   TIMESTAMP DEFAULT SYSTIMESTAMP,
    CARD_ID      VARCHAR2(255),
    SESSION_ID   NUMBER,
    IP_ADDRESS   VARCHAR2(255),
    USER_AGENT   VARCHAR2(4000),
    PAGE_ID      NUMBER
);
```

### Шаг 2: Создание REST-сервиса для приема данных Beacon

В Oracle APEX создайте REST-сервис для обработки POST-запросов от Beacon API:

#### 2.1 Создание модуля REST Data Services

1. Перейдите в **Shared Components → REST Data Services**
2. Создайте новый **REST Module** с именем `beacon_logging`
3. Установите **Base Path**: `/beacon/`

#### 2.2 Создание обработчика для логирования

Создайте **Resource Handler** со следующими параметрами:

- **Method**: POST
- **Source Type**: PL/SQL
- **Source**:

```sql
DECLARE
    l_request_body CLOB;
    l_card_id VARCHAR2(255);
    l_json_obj JSON_OBJECT_T;
BEGIN
    -- Получаем тело запроса
    l_request_body := :body_text;
    
    -- Обработка различных типов данных от sendBeacon
    IF INSTR(l_request_body, '{') = 1 THEN
        -- JSON данные
        l_json_obj := JSON_OBJECT_T.parse(l_request_body);
        l_card_id := l_json_obj.get_string('cardId');
    ELSE
        -- Текстовые данные
        l_card_id := TRIM(l_request_body);
    END IF;
    
    -- Вставляем лог
    INSERT INTO BEACON_CLICK_LOG (
        USERNAME,
        CARD_ID,
        SESSION_ID,
        IP_ADDRESS,
        USER_AGENT,
        PAGE_ID
    ) VALUES (
        NVL(USER, 'ANONYMOUS'),
        l_card_id,
        NVL(SYS_CONTEXT('APEX$SESSION', 'APP_SESSION'), 0),
        SYS_CONTEXT('USERENV', 'IP_ADDRESS'),
        OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'),
        NVL(TO_NUMBER(SYS_CONTEXT('APEX$SESSION', 'APP_PAGE_ID')), 0)
    );
    
    COMMIT;
    
    -- Возвращаем статус 204 (No Content) как рекомендуется для Beacon API
    :status := 204;
    
EXCEPTION
    WHEN OTHERS THEN
        -- Логируем ошибку
        INSERT INTO BEACON_CLICK_LOG (
            USERNAME,
            CARD_ID,
            SESSION_ID
        ) VALUES (
            'ERROR',
            SUBSTR(SQLERRM, 1, 255),
            -1
        );
        COMMIT;
        :status := 500;
END;
```

### Шаг 3: Настройка HTML-карточек в статическом контенте

Модифицируйте HTML-код ваших карточек для поддержки Beacon API:

```html
<div class="card-container">
    <a href="f?p=&APP_ID.:2:&APP_SESSION." 
       class="card-link" 
       data-card-id="card-dashboard"
       data-beacon-url="&APP_FILES.beacon/log">
        <div class="card">
            <h3>Dashboard</h3>
            <p>Просмотр основной панели</p>
        </div>
    </a>
    
    <a href="f?p=&APP_ID.:3:&APP_SESSION." 
       class="card-link" 
       data-card-id="card-reports"
       data-beacon-url="&APP_FILES.beacon/log">
        <div class="card">
            <h3>Отчёты</h3>
            <p>Управление отчётами</p>
        </div>
    </a>
</div>
```

### Шаг 4: Реализация JavaScript для Beacon API

Добавьте следующий JavaScript-код на вашу страницу (в **Page Properties → JavaScript → Execute when Page Loads**):

```javascript
(function() {
    'use strict';
    
    // Проверка поддержки Beacon API
    if (!navigator.sendBeacon) {
        console.warn('Beacon API не поддерживается в этом браузере');
        return;
    }
    
    // Функция для отправки данных через Beacon API
    function sendBeaconLog(cardId, url) {
        try {
            // Создаем объект с данными для логирования
            const logData = {
                cardId: cardId,
                timestamp: new Date().toISOString(),
                sessionId: $v('pInstance'),
                pageId: $v('pFlowStepId'),
                userAgent: navigator.userAgent
            };
            
            // Отправляем данные как JSON через Blob
            const blob = new Blob([JSON.stringify(logData)], {
                type: 'application/json'
            });
            
            const success = navigator.sendBeacon(url, blob);
            
            if (!success) {
                console.warn('Не удалось поставить beacon-запрос в очередь');
            }
            
            return success;
            
        } catch (error) {
            console.error('Ошибка при отправке beacon:', error);
            return false;
        }
    }
    
    // Обработчик кликов для карточек
    function handleCardClick(event) {
        const target = event.currentTarget;
        const cardId = target.dataset.cardId;
        const beaconUrl = target.dataset.beaconUrl;
        
        if (cardId && beaconUrl) {
            // Отправляем лог клика
            const success = sendBeaconLog(cardId, beaconUrl);
            
            if (success) {
                console.log('Beacon отправлен для карточки:', cardId);
            }
        }
    }
    
    // Инициализация обработчиков событий
    function initBeaconLogging() {
        const cardLinks = document.querySelectorAll('.card-link');
        
        cardLinks.forEach(link => {
            link.addEventListener('click', handleCardClick);
        });
        
        console.log('Beacon logging инициализирован для', cardLinks.length, 'карточек');
    }
    
    // Запуск после загрузки DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBeaconLogging);
    } else {
        initBeaconLogging();
    }
    
    // Дополнительное логирование при покидании страницы
    window.addEventListener('beforeunload', function() {
        const pageExitData = {
            cardId: 'page-exit',
            timestamp: new Date().toISOString(),
            sessionId: $v('pInstance'),
            pageId: $v('pFlowStepId')
        };
        
        const blob = new Blob([JSON.stringify(pageExitData)], {
            type: 'application/json'
        });
        
        // Используем первую доступную beacon URL
        const firstCard = document.querySelector('.card-link');
        if (firstCard && firstCard.dataset.beaconUrl) {
            navigator.sendBeacon(firstCard.dataset.beaconUrl, blob);
        }
    });
    
})();
```

### Шаг 5: Обработка различных типов данных

Beacon API поддерживает различные типы данных[2]. Вот примеры для разных сценариев:

#### 5.1 Отправка простой строки

```javascript
function sendSimpleBeacon(cardId, url) {
    const data = `card_clicked:${cardId}:${Date.now()}`;
    return navigator.sendBeacon(url, data);
}
```

#### 5.2 Отправка FormData

```javascript
function sendFormDataBeacon(cardId, url) {
    const formData = new FormData();
    formData.append('cardId', cardId);
    formData.append('timestamp', new Date().toISOString());
    formData.append('sessionId', $v('pInstance'));
    
    return navigator.sendBeacon(url, formData);
}
```

#### 5.3 Отправка URLSearchParams

```javascript
function sendUrlParamsBeacon(cardId, url) {
    const params = new URLSearchParams();
    params.append('cardId', cardId);
    params.append('timestamp', new Date().toISOString());
    params.append('sessionId', $v('pInstance'));
    
    return navigator.sendBeacon(url, params);
}
```

### Шаг 6: Настройка обработчика для разных типов данных

Обновите PL/SQL-код REST-обработчика для работы с различными типами данных:

```sql
DECLARE
    l_request_body CLOB;
    l_card_id VARCHAR2(255);
    l_content_type VARCHAR2(255);
    l_json_obj JSON_OBJECT_T;
BEGIN
    -- Получаем тело запроса и тип содержимого
    l_request_body := :body_text;
    l_content_type := :content_type;
    
    -- Обработка в зависимости от типа содержимого
    CASE 
        WHEN l_content_type LIKE 'application/json%' THEN
            -- JSON данные
            l_json_obj := JSON_OBJECT_T.parse(l_request_body);
            l_card_id := l_json_obj.get_string('cardId');
            
        WHEN l_content_type LIKE 'application/x-www-form-urlencoded%' THEN
            -- URL-encoded данные
            l_card_id := REGEXP_SUBSTR(l_request_body, 'cardId=([^&]+)', 1, 1, NULL, 1);
            
        WHEN l_content_type LIKE 'multipart/form-data%' THEN
            -- Multipart данные (требует дополнительной обработки)
            l_card_id := REGEXP_SUBSTR(l_request_body, 'name="cardId"[^"]*"([^"]+)"', 1, 1, NULL, 1);
            
        ELSE
            -- Текстовые данные по умолчанию
            l_card_id := TRIM(REGEXP_SUBSTR(l_request_body, 'card_clicked:([^:]+):', 1, 1, NULL, 1));
    END CASE;
    
    -- Вставляем лог
    INSERT INTO BEACON_CLICK_LOG (
        USERNAME,
        CARD_ID,
        SESSION_ID,
        IP_ADDRESS,
        USER_AGENT,
        PAGE_ID
    ) VALUES (
        NVL(USER, 'ANONYMOUS'),
        l_card_id,
        NVL(SYS_CONTEXT('APEX$SESSION', 'APP_SESSION'), 0),
        SYS_CONTEXT('USERENV', 'IP_ADDRESS'),
        OWA_UTIL.GET_CGI_ENV('HTTP_USER_AGENT'),
        NVL(TO_NUMBER(SYS_CONTEXT('APEX$SESSION', 'APP_PAGE_ID')), 0)
    );
    
    COMMIT;
    
    -- Возвращаем статус 204 (No Content)
    :status := 204;
    
EXCEPTION
    WHEN OTHERS THEN
        -- Логируем ошибку
        INSERT INTO BEACON_CLICK_LOG (
            USERNAME,
            CARD_ID,
            SESSION_ID
        ) VALUES (
            'ERROR',
            SUBSTR(SQLERRM, 1, 255),
            -1
        );
        COMMIT;
        :status := 500;
END;
```

### Шаг 7: Создание отчета для просмотра логов

Создайте интерактивный отчет для просмотра логов кликов:

```sql
SELECT 
    ID,
    USERNAME,
    CARD_ID,
    TO_CHAR(CLICK_TIME, 'DD.MM.YYYY HH24:MI:SS') AS CLICK_TIME,
    SESSION_ID,
    IP_ADDRESS,
    PAGE_ID,
    CASE 
        WHEN CARD_ID = 'page-exit' THEN 'Выход со страницы'
        WHEN CARD_ID = 'ERROR' THEN 'Ошибка'
        ELSE 'Клик по карточке'
    END AS ACTION_TYPE
FROM BEACON_CLICK_LOG
WHERE CLICK_TIME >= TRUNC(SYSDATE) - 7  -- Последние 7 дней
ORDER BY CLICK_TIME DESC
```

### Шаг 8: Тестирование и отладка

#### 8.1 Проверка поддержки браузера

```javascript
function checkBeaconSupport() {
    if ('sendBeacon' in navigator) {
        console.log('✅ Beacon API поддерживается');
        return true;
    } else {
        console.log('❌ Beacon API не поддерживается');
        return false;
    }
}
```

#### 8.2 Отладка запросов

Включите логирование веб-сервисов в APEX[5]:

1. Перейдите в **Workspace Administration → Manage Service → Web Service Activity Log**
2. Включите логирование
3. Просматривайте логи запросов в `APEX_WEBSERVICE_LOG`

#### 8.3 Просмотр запросов в Developer Tools

Для просмотра beacon-запросов в Developer Tools:

1. Откройте **Network** tab
2. Включите **Persist Logs**
3. Beacon-запросы могут отображаться как "(Pending)" — это нормально[6]

### Заключение

Реализация логирования через Beacon API в Oracle APEX 23.1 обеспечивает надежную и эффективную систему отслеживания пользовательских действий. Основные преимущества данного подхода:

- **Гарантированная доставка**: логи отправляются даже при быстром переходе между страницами[1]
- **Отсутствие блокировки**: не замедляет работу пользователей[3]
- **Простота реализации**: минимум кода для максимальной функциональности[4]
- **Совместимость**: работает во всех современных браузерах[2]

Данная система позволяет получить полную картину взаимодействия пользователей с вашим приложением APEX, что критически важно для анализа поведения пользователей и оптимизации интерфейса.

Цитаты:
[1] Navigator: sendBeacon() method - Web APIs | MDN https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon
[2] Beacon API - MDN Web Docs https://developer.mozilla.org/en-US/docs/Web/API/Beacon_API
[3] How to log user activities using the Beacon Web API? https://blog.greenroots.info/how-to-log-user-activities-using-the-beacon-web-api
[4] Logging Activity With The Web Beacon API - Smashing Magazine https://www.smashingmagazine.com/2018/07/logging-activity-web-beacon-api/
[5] APEX 18.1 New Feature: Logging Web Service Requests http://jastraub.blogspot.com/2018/03/apex-181-new-feature-logging-web.html
[6] Using the Beacon API - Request Metrics https://requestmetrics.com/building/using-the-beacon-api
[7] API Reference - Oracle Help Center https://docs.oracle.com/en/database/oracle/apex/22.1/aeapi/APEX_DEBUG.html
[8] sendBeacon examples - SmileCat https://egaoneko.github.io/playground/examples/send-beacon.html
[9] Navigator: sendBeacon() method Example - GitHub https://github.com/sushantrahate/send-beacon-nodejs
[10] How to receive data posted by "navigator.sendbeacon" on node.js ... https://stackoverflow.com/questions/31355128/how-to-receive-data-posted-by-navigator-sendbeacon-on-node-js-server
[11] The Right Way to Send Analytics & Logs on Page Exit | Ahmad Jafari https://www.linkedin.com/posts/jafari-dev_the-beacon-api-the-right-way-to-send-activity-7304152456282710016-iIBq
[12] sendBeacon in JavaScript - DEV Community https://dev.to/silentwatcher_95/sendbeacon-in-javascript-3pm
[13] Using navigator.sendBeacon() To Publish Analytics Back To ... https://www.bennadel.com/blog/4444-using-navigator-sendbeacon-to-publish-analytics-back-to-coldfusion.htm
[14] Oracle APEX Web Service Logs - Stack Overflow https://stackoverflow.com/questions/51257349/oracle-apex-web-service-logs
[15] Отправка данных через navigator.sendBeacon - HTML Academy https://htmlacademy.ru/blog/tags/feature-beacons
[16] 22.3 Utilizing Logs and Reports - APEX - Oracle Help Center https://docs.oracle.com/en/database/oracle/apex/22.1/htmdb/utilizing-logs-and-reports.html
[17] Логирование активности с использованием Web Beacon API - Habr https://habr.com/ru/articles/419137/
[18] Oracle Apex 4.2 Dynamic action with custom event "beforeunload ... https://stackoverflow.com/questions/60115946/oracle-apex-4-2-dynamic-action-with-custom-event-beforeunload-not-working
[19] Using Navigator sendBeacon - YouTube https://www.youtube.com/watch?v=fmoolce6uDo
[20] How to Debug your REST APIs in Oracle REST Data Services https://www.thatjeffsmith.com/archive/2021/08/how-to-debug-your-rest-apis-in-oracle-rest-data-services/
[21] Как реализовать sendBeacon для надежной передачи данных ... https://flaming.codes/ru/posts/special-network-function-for-analytics-data-in-browser
[22] API Reference - APEX - Oracle Help Center https://docs.oracle.com/en/database/oracle/apex/23.1/aeapi/APEX_DEBUG.html
[23] Beacon REST API - Beacon Protocol Documentation https://docs.genomebeacons.org/rest-api/
[24] 22.8 Creating Custom Activity Reports Using APEX_ACTIVITY_LOG https://docs.oracle.com/en/database/oracle/apex/23.1/htmdb/creating-custom-activity-reports-using-apex_activity_log.html
[25] Can Apex REST interact with other REST API's to obtain binary data ... https://salesforce.stackexchange.com/questions/218623/can-apex-rest-interact-with-other-rest-apis-to-obtain-binary-data-for-copying-d
[26] SEND Procedure - Oracle Help Center https://docs.oracle.com/database/apex-18.1/AEAPI/SEND-Procedure1.htm
[27] 2.9 Purging the Developer Activity and Click Count Log Files https://docs.oracle.com/en/database/oracle/apex/23.1/aeadm/purging-the-developer-activity-and-click-count-log-files.html
[28] How to fetch records through REST API in Apex class Salesforce https://eshopsync.com/how-to-fetch-records-through-rest-api-in-apex-class-salesforce/
[29] How to access data sent by navigator.sendBeacon https://www.html5gamedevs.com/topic/17832-how-to-access-data-sent-by-navigatorsendbeacon/
[30] Apex REST Methods - Salesforce Developers https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_rest_methods.htm
[31] Oracle Apex to receive form submit POST data - Stack Overflow https://stackoverflow.com/questions/68115063/oracle-apex-to-receive-form-submit-post-data/71608893
[32] Beacon's API https://guide.beaconcrm.org/en/articles/5720215-beacon-s-api
[33] Send POST request to Oracle APEX or PLSQL procedure https://stackoverflow.com/questions/33416868/send-post-request-to-oracle-apex-or-plsql-procedure
[34] Building an Inbound Rest API for Salesforce | Bluewave IE https://bluewavecx.com/ie/blog/inbound-rest-api-salesforce/
[35] 18.6 SEND Procedure - Oracle Help Center https://docs.oracle.com/database/apex-5.1/AEAPI/SEND-Procedure.htm
[36] Exposing Apex Classes as REST Web Services https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_rest.htm
[37] SEND Procedure - Oracle Help Center https://docs.oracle.com/cd/E37097_01/doc.42/e35127/GUID-B8E13429-BCED-4079-8AD6-BCF91BEA59BC.htm
[38] How to Integrate Salesforce Apex with Other Applications https://www.integrate.io/blog/salesforce-apex-integration/
[39] How to Post Data from Outside Oracle using APEX Application? https://forums.oracle.com/ords/apexds/post/how-to-post-data-from-outside-oracle-using-apex-application-9928
[40] 7.1 About Oracle RESTful Services in Oracle APEX https://docs.oracle.com/en/database/oracle/apex/23.2/aeutl/about-oracle-restful-services-in-apex.html
[41] How do you return a plain text string from an ORDS REST endpoint? https://stackoverflow.com/questions/62135808/how-do-you-return-a-plain-text-string-from-an-ords-rest-endpoint
[42] Oracle APEX APEX_WEB_SERVICE the Definitive Guide https://blog.cloudnueva.com/apexwebservice-the-definitive-guide
[43] REST API / WebEditor | APEX Office Print (AOP) https://www.apexofficeprint.com/docs/API/rest-api/
[44] Invoke REST Endpoint With Plain Text Payload - A-Team Chronicles https://www.ateam-oracle.com/post/invoke-rest-endpoint-with-plain-text-payload
[45] apex_web_service.make_rest_request not working with POST https://apexdebug.com/apexwebservicemakerestrequest-not-working-with-post
[46] Navigator.sendBeacon() to pass header information - Stack Overflow https://stackoverflow.com/questions/40523469/navigator-sendbeacon-to-pass-header-information
[47] Rest Service Response is coming in text/plain not in Json format https://forums.oracle.com/ords/apexds/post/rest-service-response-is-coming-in-text-plain-not-in-json-f-1579
[48] [PDF] GET POST ORDS JSON: Web Services for APEX Decoded https://pic.huodongjia.com/ganhuodocs/2017-11-20/1511164555.59.pdf
[49] ORDS - HTTP Responses and Forwarding for your REST APIs https://www.thatjeffsmith.com/archive/2018/10/x-ords-forward-ords-response-forward-to-another-resource/
[50] Invoking/sending POST parameters using APEX_WEB_SERVICE https://oscarjgordillo.wordpress.com/2018/11/24/invoking-sending-post-parameters-using-apex_web_service/
[51] Using Send-Email Process and PLSQL API - apex_mail.send() https://www.youtube.com/watch?v=rON9tLxo3TI
[52] Multipart/Form-Data requests with APEX_WEB_SERVICE - APEX Blog https://apexblog.dev/multipartform-data-requests-with-apexwebservice
[53] how to debug web source modules and apex_web_service ... https://forums.oracle.com/ords/apexds/post/how-to-debug-web-source-modules-and-apex-web-service-make-r-9540
[54] Oracle APEX Process Flow Application - YouTube https://www.youtube.com/watch?v=mkoU9dsJgJw
[55] Report and Form on a REST Service: Low Code with APEX 19.1 https://blogs.oracle.com/apex/post/report-and-form-on-a-rest-service-low-code-with-apex-191
[56] APEX_WEB_SERVICE - Oracle Help Center https://docs.oracle.com/cd/E59726_01/doc.50/e39149/apex_web_service.htm
